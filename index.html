<!DOCTYPE html>
<html lang="ko">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Smart Circuit v45 (Custom Formula & RMS)</title>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
Â  Â  <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  body { margin: 0; padding: 0; overflow: hidden; background: #f8f9fa; font-family: 'Segoe UI', sans-serif; user-select: none; display: flex; flex-direction: column; height: 100vh; }
Â  Â  Â  Â  * { box-sizing: border-box; }
Â  Â  Â  Â  ::-webkit-scrollbar { width: 8px; height: 8px; }
Â  Â  Â  Â  ::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 4px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* HEADER */
Â  Â  Â  Â  #main-header { height: 50px; background: #343a40; color: white; display: flex; align-items: center; padding: 0 20px; flex-shrink: 0; position: relative; }
Â  Â  Â  Â  #app-title { font-size: 18px; font-weight: bold; position: absolute; left: 50%; transform: translateX(-50%); }
Â  Â  Â  Â  .header-btns { position: absolute; right: 20px; display: flex; gap: 10px; }
Â  Â  Â  Â  .header-btn { background: #495057; color: white; border: 1px solid #adb5bd; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
Â  Â  Â  Â  .header-btn:hover { background: #6c757d; }

Â  Â  Â  Â  /* LAYOUT */
Â  Â  Â  Â  #app { display: flex; flex: 1; width: 100vw; overflow: hidden; }
Â  Â  Â  Â  .pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #left-pane { border-right: 4px solid #dee2e6; }
Â  Â  Â  Â  #container { height: 50%; width: 100%; min-height: 0; background: #f1f3f5; border-bottom: 4px solid #dee2e6; position: relative; }
Â  Â  Â  Â  #result-panel { height: 50%; background: white; padding: 0; overflow: hidden; display: flex; flex-direction: column; }

Â  Â  Â  Â  #right-pane { background: #fff; }
Â  Â  Â  Â  #graph-section { height: 50%; display: flex; flex-direction: column; border-bottom: 4px solid #dee2e6; padding: 10px; background: #fff; position: relative; min-height: 0; }
Â  Â  Â  Â  #fft-section { height: 50%; display: flex; flex-direction: column; background: #fff; overflow: hidden; position: relative; padding: 10px; }

Â  Â  Â  Â  /* CONTROLS */
Â  Â  Â  Â  #graph-controls { padding: 5px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 5px; }
Â  Â  Â  Â  .ctrl-row { display: flex; gap: 5px; align-items: center; margin-bottom: 2px; flex-wrap: wrap; }
Â  Â  Â  Â  .ctrl-label { font-size: 11px; font-weight: 700; color: #555; width: 60px; }
Â  Â  Â  Â  .inp { padding: 3px; border: 1px solid #ced4da; border-radius: 3px; font-size: 11px; width: 60px; text-align: center; }
Â  Â  Â  Â  .inp-sel { padding: 2px; border: 1px solid #ced4da; border-radius: 3px; font-size: 11px; }
Â  Â  Â  Â  #chart-wrapper { flex: 1; position: relative; min-height: 0; }

Â  Â  Â  Â  /* Custom Formula Area */
Â  Â  Â  Â  #custom-calc-area { padding: 8px; background: #e9ecef; border-bottom: 1px solid #dee2e6; display:flex; gap:5px; align-items:center; }
Â  Â  Â  Â  #formula-inp { flex:1; padding:4px; border:1px solid #ced4da; border-radius:3px; font-size:11px; }

Â  Â  Â  Â  .panel-header { padding: 8px 15px; background: #e9ecef; border-bottom: 1px solid #dee2e6; font-weight: bold; font-size: 13px; color: #495057; display:flex; align-items:center; justify-content: space-between; }
Â  Â  Â  Â  #res-content { flex: 1; padding: 0; overflow-y: auto; }

Â  Â  Â  Â  #toolbar { position: absolute; top: 15px; left: 15px; width: 140px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 10; }
Â  Â  Â  Â  .tool-sec { margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
Â  Â  Â  Â  .tool-tit { font-size: 10px; color: #888; font-weight: bold; margin-bottom: 4px; }
Â  Â  Â  Â  .btn { width: 100%; padding: 5px; margin-bottom: 4px; border: 1px solid #ced4da; background: #fff; border-radius: 4px; cursor: pointer; font-size: 11px; text-align: left; display: flex; align-items: center; transition: 0.1s; }
Â  Â  Â  Â  .btn:hover { background: #e7f5ff; border-color: #339af0; }
Â  Â  Â  Â  .btn-primary { background: #228be6; color: white; border: none; justify-content: center; font-weight: bold; }
Â  Â  Â  Â  .btn-stop { background: #fa5252; color: white; border: none; justify-content: center; font-weight: bold; }
Â  Â  Â  Â  .btn-util { background: #868e96; color: white; border: none; justify-content: center; font-weight: bold; }
Â  Â  Â  Â  .badge { display: inline-block; width: 18px; text-align: center; margin-right: 5px; font-weight: 800; font-size: 10px; }

Â  Â  Â  Â  #progress-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; flex-direction:column; z-index:20; }
Â  Â  Â  Â  #p-bar { width:200px; height:6px; background:#ddd; border-radius:3px; margin-top:5px; overflow:hidden; }
Â  Â  Â  Â  #p-fill { width:0%; height:100%; background:#228be6; transition:width 0.1s; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .res-table { width: 100%; border-collapse: collapse; font-size: 11px; }
Â  Â  Â  Â  .res-table th { background: #f1f3f5; padding: 6px; border: 1px solid #dee2e6; text-align: center; position: sticky; top: 0; z-index: 2; }
Â  Â  Â  Â  .res-table td { padding: 6px; border: 1px solid #dee2e6; text-align: center; }
Â  Â  Â  Â  .custom-row { background-color: #f3f0ff; color: #5f3dc4; font-weight:bold; }
Â  Â  Â  Â  .btn-del-row { background:none; border:none; cursor:pointer; color:#fa5252; font-weight:bold; }

Â  Â  Â  Â  /* DRAGGABLE GUIDE MODAL */
Â  Â  Â  Â  #guide-modal { display: none; position: fixed; top: 100px; left: 100px; width: 400px; height: 500px; background: #fff; border: 1px solid #adb5bd; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; flex-direction: column; resize: both; overflow: hidden; }
Â  Â  Â  Â  #guide-header-bar { padding: 10px; background: #343a40; color: white; cursor: move; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
Â  Â  Â  Â  #guide-body { flex: 1; padding: 15px; overflow-y: auto; font-size: 12px; line-height: 1.6; color: #333; background: #f8f9fa;}
Â  Â  Â  Â  #guide-body ul { padding-left: 20px; margin: 0; }
Â  Â  Â  Â  #guide-body li { margin-bottom: 6px; }

Â  Â  Â  Â  /* FFT PANEL */
Â  Â  Â  Â  #fft-controls { display:flex; gap:5px; align-items:center; font-size:11px; margin-bottom: 5px; flex-wrap: wrap; background: #f1f3f5; padding: 5px; border-radius: 5px;}
Â  Â  Â  Â  #fft-chart-area { flex:1; position:relative; min-height:0; border-bottom:1px solid #eee; margin-bottom:5px;}
Â  Â  Â  Â  #fft-peaks-area { height: 120px; overflow-y:auto; font-size:11px; border: 1px solid #dee2e6; }
Â  Â  Â  Â  .peak-table { width:100%; border-collapse:collapse; text-align:center; }
Â  Â  Â  Â  .peak-table th { background:#e9ecef; position:sticky; top:0; padding:4px; font-size: 11px;}
Â  Â  Â  Â  .peak-table td { border-bottom:1px solid #eee; padding:3px; }
Â  Â  Â  Â  .peak-table tr:hover { background:#f1f3f5; cursor:pointer; }
Â  Â  Â  Â  .peak-row-active { background:#ffec99 !important; font-weight:bold; }


Â  Â  Â  Â Â 
/* --- MOBILE RESPONSIVE STYLES --- */
Â  Â  @media screen and (max-width: 768px) {
Â  Â  Â  Â  /* 1. ì „ì²´ ë ˆì´ì•„ì›ƒì„ ì„¸ë¡œë¡œ ë³€ê²½ */
Â  Â  Â  Â  #app { flex-direction: column; height: 100vh; overflow-y: auto; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 2. íŒ¨ë„ ë†’ì´ ì¬ë¶„ë°° (ìƒë‹¨ íšŒë¡œ: 55%, í•˜ë‹¨ ê·¸ë˜í”„: 45%) */
Â  Â  Â  Â  .pane { width: 100%; flex: none; }
Â  Â  Â  Â  #left-pane { height: 55vh; border-right: none; border-bottom: 4px solid #dee2e6; display: flex; flex-direction: column; }
Â  Â  Â  Â  #right-pane { height: 45vh; display: flex; flex-direction: column; }

Â  Â  Â  Â  /* 3. ë‚´ë¶€ ì„¹ì…˜ ë†’ì´ ì¡°ì • */
Â  Â  Â  Â  /* íšŒë¡œ ì˜ì—­ì„ ë” ë„“ê²Œ í™•ë³´ */
Â  Â  Â  Â  #container { height: 65% !important; }Â 
Â  Â  Â  Â  #result-panel { height: 35% !important; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ê·¸ë˜í”„ì™€ FFT íŒ¨ë„ íƒ­ í˜•ì‹ ë˜ëŠ” ë†’ì´ ì¡°ì • */
Â  Â  Â  Â  #graph-section { height: 60% !important; }
Â  Â  Â  Â  #fft-section { height: 40% !important; }

Â  Â  Â  Â  /* 4. íˆ´ë°” ìœ„ì¹˜ ë° í¬ê¸° ì¡°ì • (ëª¨ë°”ì¼ì—ì„œ ë„ˆë¬´ í¬ì§€ ì•Šê²Œ) */
Â  Â  Â  Â  #toolbar {Â 
Â  Â  Â  Â  Â  Â  top: 5px; left: 5px; width: 110px;Â 
Â  Â  Â  Â  Â  Â  padding: 5px; max-height: 60vh; overflow-y: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â  .tool-tit { font-size: 9px; }
Â  Â  Â  Â  .btn { font-size: 10px; padding: 4px; }

Â  Â  Â  Â  /* 5. ì»¨íŠ¸ë¡¤ íŒ¨ë„ ì¤„ë°”ê¿ˆ í—ˆìš© (ì…ë ¥ì°½ ì§¤ë¦¼ ë°©ì§€) */
Â  Â  Â  Â  .ctrl-row { flex-wrap: wrap; gap: 8px; }
Â  Â  Â  Â  .ctrl-label { width: auto; margin-right: 5px; }
Â  Â  Â  Â  .inp { width: 50px; font-size: 12px; padding: 5px; }
Â  Â  Â  Â  .btn-primary, .btn-stop { padding: 8px; } /* í„°ì¹˜í•˜ê¸° ì‰½ê²Œ ë²„íŠ¼ í‚¤ì›€ */

Â  Â  Â  Â  /* 6. ëª¨ë‹¬ ì°½ (ë§¤ë‰´ì–¼, FFT) ëª¨ë°”ì¼ ìµœì í™” */
Â  Â  Â  Â  #guide-modal {Â 
Â  Â  Â  Â  Â  Â  width: 90% !important; height: 70% !important;Â 
Â  Â  Â  Â  Â  Â  top: 15% !important; left: 5% !important;Â 
Â  Â  Â  Â  Â  Â  transform: none !important; /* ë“œë˜ê·¸ ìœ„ì¹˜ ì´ˆê¸°í™” */
Â  Â  Â  Â  }
Â  Â  Â  Â  #fft-modal #fft-box { width: 95%; height: 80%; padding: 10px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* 7. í°íŠ¸ ì‚¬ì´ì¦ˆ ì „ë°˜ì  í™•ëŒ€ */
Â  Â  Â  Â  body { font-size: 14px; }
Â  Â  Â  Â  .panel-header { padding: 5px 10px; font-size: 12px; }
Â  Â  }

Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Guestbook Specific */
Â  Â  Â  Â  #guest-list { list-style: none; padding: 0; margin: 0; }
Â  Â  Â  Â  .guest-item { border-bottom: 1px solid #eee; padding: 8px 0; }
Â  Â  Â  Â  .guest-nick { font-weight: bold; color: #228be6; font-size: 12px; }
Â  Â  Â  Â  .guest-msg { color: #333; font-size: 12px; margin-top: 2px; }
Â  Â  Â  Â  .guest-time { color: #aaa; font-size: 10px; float: right; }
Â  Â  Â  Â  #guest-form { display: flex; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
Â  Â  </style>
</head>
<body>

<div id="main-header">
Â  Â  <div id="app-title">Online Circuit Simulator for Beginners</div>
Â  Â  <div class="header-btns">
Â  Â  Â  Â  <button id="guest-btn" class="header-btn" onclick="toggleGuestbook()">ğŸ–Šï¸ Guestbook</button>
Â  Â  Â  Â  <button id="manual-btn" class="header-btn" onclick="toggleGuide()">ğŸ“– Manual</button>
Â  Â  Â  Â  <button id="lang-btn" class="header-btn" onclick="toggleLanguage()">ğŸŒ English</button>
Â  Â  </div>
</div>

<div id="guide-modal" style="display:none;">
Â  Â  <div id="guide-header-bar">
Â  Â  Â  Â  <span style="font-weight:bold;" data-txt="guideTitle">ğŸ“˜ D. App User Guide</span>
Â  Â  Â  Â  <button style="background:none; border:none; color:white; font-weight:bold; cursor:pointer;" onclick="toggleGuide()">âœ•</button>
Â  Â  </div>
Â  Â  <div id="guide-body">
Â  Â  Â  Â  <ul id="guide-list"></ul>
Â  Â  </div>
</div>

<div id="app">
Â  Â  <div id="left-pane" class="pane">
Â  Â  Â  Â  <div id="container"></div>
Â  Â  Â  Â  <div id="result-panel">
Â  Â  Â  Â  Â  Â  <div class="panel-header"><span data-txt="resTitle">ğŸ“Š C. Steady State Analysis</span></div>
Â  Â  Â  Â  Â  Â  <div id="custom-calc-area">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:11px; font-weight:bold; color:#555;">Formula:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="formula-inp" placeholder="e.g. V(N2)*conj(I(L1))">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" style="width:auto; margin:0; padding:4px 8px;" onclick="addCustomFormula()">Add</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="res-content"><div style="color:#888; font-size:11px; text-align:center; padding-top:40px;" data-txt="resPlaceholder">Press [âš¡ Steady State] to see results.</div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="toolbar">
Â  Â  Â  Â  Â  Â  <div class="tool-sec">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tool-tit" data-txt="t_grid">GRID</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" style="justify-content:center;" onclick="updateRailCount(-1)">-</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" style="justify-content:center;" onclick="updateRailCount(1)">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="tool-sec">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tool-tit" data-txt="t_file">FILE</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-util" onclick="saveCircuit()"><span data-txt="b_save">ğŸ’¾ Save</span></button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-util" onclick="document.getElementById('fileInput').click()"><span data-txt="b_load">ğŸ“‚ Load</span></button>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="fileInput" style="display:none" onchange="loadCircuit(this)">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="tool-sec">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tool-tit" data-txt="t_mode">MODE</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="runSteady()"><span data-txt="b_steady">âš¡ Steady State</span></button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="tool-sec">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="tool-tit" data-txt="t_parts">PARTS</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="spawn('V_DC')"><span class="badge" style="color:#e03131">V</span>DC</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="spawn('V_AC')"><span class="badge" style="color:#1971c2">~</span>AC</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="spawn('I_AC')"><span class="badge" style="color:#1098ad">I</span>AC</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="spawn('R')"><span class="badge">R</span>Res</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="spawn('L')"><span class="badge">L</span>Ind</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="spawn('C')"><span class="badge">C</span>Cap</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="spawn('T')"><span class="badge" style="color:#f08c00">T</span>Trans</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn" style="justify-content:center; background:#f8f9fa;" onclick="resetAll()"><span data-txt="b_reset">Reset All</span></button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="right-pane" class="pane">
Â  Â  Â  Â  <div id="graph-section">
Â  Â  Â  Â  Â  Â  <div class="panel-header" style="background:#fff; padding-left:0; border:none; margin-bottom:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  <span data-txt="transTitle">ğŸ“ˆ B. Transient Simulation</span>
Â  Â  Â  Â  Â  Â  Â  Â  <button style="font-size:10px; padding:2px 6px; background:#fab005; border:none; border-radius:3px; color:white; font-weight:bold; cursor:pointer;" onclick="autoSetParams()">âœ¨ Auto Scale</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="graph-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ctrl-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="ctrl-label" data-txt="l_time">Time</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="xMin" class="inp" value="0"> ~
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="xMax" class="inp" value="50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="timeUnit" class="inp-sel"><option value="us">us</option><option value="ms" selected>ms</option><option value="s">s</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ctrl-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="ctrl-label">Step(dt)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="dtInput" class="inp" value="10u" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="ctrl-label" style="width:40px; text-align:right;">Y-Axis</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="yMax" class="inp" placeholder="Auto">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ctrl-row" style="margin-top:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" style="flex:2; padding:5px; border-radius:4px; border:none; cursor:pointer;" onclick="startSimulation()"><span data-txt="b_run">â–¶ Run</span></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-stop" style="flex:1; padding:5px; border-radius:4px; border:none; cursor:pointer;" onclick="stopSimulation()"><span data-txt="b_stop">â¹ Stop</span></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button style="flex:1; padding:5px; border-radius:4px; border:1px solid #ccc; background:#fff; cursor:pointer;" onclick="exportData()">CSV</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="chart-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="myChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="progress-overlay">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:bold; color:#555;">Simulating...</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="p-bar"><div id="p-fill"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="status-text">0%</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="fft-section">
Â  Â  Â  Â  Â  Â  <div class="panel-header" style="background:#fff; padding-left:0; border:none; margin-bottom:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:bold;">ğŸ“Š C-2. FFT Spectrum</span>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-util" style="font-size:10px; padding:2px 6px; width:auto;" onclick="performFFT()">ğŸ”„ Update</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="fft-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <span><b>Src:</b></span>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="fft-src" class="inp-sel" onchange="performFFT()" style="width:70px"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <span><b>Range:</b></span>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="fft-min" class="inp" value="0" style="width:40px" onchange="performFFT()"> ~Â 
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="fft-max" class="inp" value="1000" style="width:50px" onchange="performFFT()"> Hz
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="fft-chart-area">
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="fftChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="fft-placeholder" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#aaa; font-size:11px;">Run Transient Sim first.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="fft-peaks-area">
Â  Â  Â  Â  Â  Â  Â  Â  <table class="peak-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Rank</th><th>Freq(Hz)</th><th>Mag</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="peak-tbody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â  // --- DRAGGABLE MODAL (Mouse & Touch Support) ---
Â  Â  const guideModal = document.getElementById("guide-modal");
Â  Â  const guideHeader = document.getElementById("guide-header-bar");
Â  Â  let isDragging = false, currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

Â  Â  function toggleGuide() {
Â  Â  Â  Â  if (guideModal.style.display === "none") {
Â  Â  Â  Â  Â  Â  guideModal.style.display = "flex";
Â  Â  Â  Â  Â  Â  // ì¤‘ì•™ ì •ë ¬ ì´ˆê¸°í™” (ë°ìŠ¤í¬íƒ‘/ëª¨ë°”ì¼ ê³µí†µ)
Â  Â  Â  Â  Â  Â  if(xOffset === 0 && yOffset === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const rect = guideModal.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  xOffset = (window.innerWidth - rect.width) / 2;
Â  Â  Â  Â  Â  Â  Â  Â  if(window.innerWidth > 768) xOffset -= 100; // ë°ìŠ¤í¬íƒ‘ ë³´ì •
Â  Â  Â  Â  Â  Â  Â  Â  yOffset = (window.innerHeight - rect.height) / 2;
Â  Â  Â  Â  Â  Â  Â  Â  if(window.innerWidth > 768) yOffset -= 100; // ë°ìŠ¤í¬íƒ‘ ë³´ì •
Â  Â  Â  Â  Â  Â  Â  Â  setTranslate(xOffset, yOffset, guideModal);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else { guideModal.style.display = "none"; }
Â  Â  }

Â  Â  // Mouse Events
Â  Â  guideHeader.addEventListener("mousedown", dragStart);
Â  Â  document.addEventListener("mousemove", drag);
Â  Â  document.addEventListener("mouseup", dragEnd);

Â  Â  // Touch Events (For Mobile)
Â  Â  guideHeader.addEventListener("touchstart", dragStart, {passive: false});
Â  Â  document.addEventListener("touchmove", drag, {passive: false});
Â  Â  document.addEventListener("touchend", dragEnd);

Â  Â  function dragStart(e) {
Â  Â  Â  Â  // í„°ì¹˜ ë˜ëŠ” ë§ˆìš°ìŠ¤ ì¢Œí‘œ í†µì¼
Â  Â  Â  Â  const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
Â  Â  Â  Â  const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

Â  Â  Â  Â  initialX = clientX - xOffset;
Â  Â  Â  Â  initialY = clientY - yOffset;

Â  Â  Â  Â  if (e.target === guideHeader || guideHeader.contains(e.target)) {
Â  Â  Â  Â  Â  Â  isDragging = true;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function drag(e) {
Â  Â  Â  Â  if (isDragging) {
Â  Â  Â  Â  Â  Â  e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
Â  Â  Â  Â  Â  Â  const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

Â  Â  Â  Â  Â  Â  currentX = clientX - initialX;
Â  Â  Â  Â  Â  Â  currentY = clientY - initialY;

Â  Â  Â  Â  Â  Â  xOffset = currentX;
Â  Â  Â  Â  Â  Â  yOffset = currentY;

Â  Â  Â  Â  Â  Â  setTranslate(currentX, currentY, guideModal);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function dragEnd(e) {
Â  Â  Â  Â  initialX = currentX;
Â  Â  Â  Â  initialY = currentY;
Â  Â  Â  Â  isDragging = false;
Â  Â  }

Â  Â  function setTranslate(x, y, el) {
Â  Â  Â  Â  el.style.transform = `translate3d(${x}px, ${y}px, 0)`;
Â  Â  }

Â  Â  // --- FFT (Improved) ---
Â  Â  const SimpleFFT = {
Â  Â  Â  Â  fft: function(data) {
Â  Â  Â  Â  Â  Â  const N = data.length;
Â  Â  Â  Â  Â  Â  if (N <= 1) return data;
Â  Â  Â  Â  Â  Â  const hN = N / 2;
Â  Â  Â  Â  Â  Â  const even = new Array(hN), odd = new Array(hN);
Â  Â  Â  Â  Â  Â  for (let i = 0; i < hN; i++) { even[i] = data[2 * i]; odd[i] = data[2 * i + 1]; }
Â  Â  Â  Â  Â  Â  const evenFFT = this.fft(even), oddFFT = this.fft(odd);
Â  Â  Â  Â  Â  Â  const res = new Array(N);
Â  Â  Â  Â  Â  Â  for (let k = 0; k < hN; k++) {
Â  Â  Â  Â  Â  Â  Â  Â  const angle = -2 * Math.PI * k / N;
Â  Â  Â  Â  Â  Â  Â  Â  const tr = oddFFT[k].re * Math.cos(angle) - oddFFT[k].im * Math.sin(angle);
Â  Â  Â  Â  Â  Â  Â  Â  const ti = oddFFT[k].re * Math.sin(angle) + oddFFT[k].im * Math.cos(angle);
Â  Â  Â  Â  Â  Â  Â  Â  res[k] = { re: evenFFT[k].re + tr, im: evenFFT[k].im + ti };
Â  Â  Â  Â  Â  Â  Â  Â  res[k + hN] = { re: evenFFT[k].re - tr, im: evenFFT[k].im - ti };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return res;
Â  Â  Â  Â  },
Â  Â  Â  Â  calculateSpectrum: function(signalData, dt) {
Â  Â  Â  Â  Â  Â  const rawN = signalData.length;
Â  Â  Â  Â  Â  Â  let n = 1; while (n < rawN) n *= 2;Â 
Â  Â  Â  Â  Â  Â  const input = new Array(n);
Â  Â  Â  Â  Â  Â  const startIndex = Math.floor(rawN * 0.1);Â 
Â  Â  Â  Â  Â  Â  const activeLen = rawN - startIndex;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (let i = 0; i < n; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  if (i < activeLen) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalVal = signalData[i + startIndex];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const windowVal = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (activeLen - 1)));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input[i] = { re: originalVal * windowVal, im: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  } else { input[i] = { re: 0, im: 0 }; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const output = this.fft(input);
Â  Â  Â  Â  Â  Â  const sampleRate = 1.0 / dt;
Â  Â  Â  Â  Â  Â  const spectrum = [];
Â  Â  Â  Â  Â  Â  const scaleFactor = 2.0 * (2.0 / activeLen);Â 
Â  Â  Â  Â  Â  Â  for (let i = 0; i < n / 2; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  let mag = Math.sqrt(output[i].re ** 2 + output[i].im ** 2) * scaleFactor;
Â  Â  Â  Â  Â  Â  Â  Â  if (i === 0) mag /= 2;
Â  Â  Â  Â  Â  Â  Â  Â  spectrum.push({ x: i * sampleRate / n, y: mag });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return spectrum;
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // --- MATH & UTILS ---
Â  Â  function parseUnit(s){if(!s)return NaN;s=s.toString();const m=s.match(/^([\d\.]+)\s*([a-zA-Z]*)$/);if(!m)return parseFloat(s);const v=parseFloat(m[1]),u=m[2],k={'p':1e-12,'n':1e-9,'u':1e-6,'m':1e-3,'k':1e3,'M':1e6,'G':1e9};return v*(k[u]||1);}
Â  Â  function formatUnit(v,u){if(Math.abs(v)<1e-15)return "0"+u;const a=Math.abs(v),r=[{v:1e9,s:'G'},{v:1e6,s:'M'},{v:1e3,s:'k'},{v:1,s:''},{v:1e-3,s:'m'},{v:1e-6,s:'u'},{v:1e-9,s:'n'},{v:1e-12,s:'p'}];for(let x of r)if(a>=x.v*0.9)return parseFloat((v/x.v).toFixed(3))+x.s+u;return v.toExponential(1)+u;}
Â  Â  function formatEng(v){if(v===0)return "0";const k={'p':1e-12,'n':1e-9,'u':1e-6,'m':1e-3,'':1};let bK='',bV=v;for(let key in k){if(Math.abs(v)>=k[key]&&k[key]<1){if(Math.abs(v)/k[key]<1000){bK=key;bV=v/k[key];break;}}}return parseFloat(bV.toFixed(2))+bK;}
Â // --- SUPABASE CONFIGURATION ---
Â  Â  // [!] PLEASE REPLACE THESE WITH YOUR OWN SUPABASE PROJECT DETAILS
Â  Â  const SUPABASE_URL = 'https://rhiaahzaftsfnbaywcby.supabase.co';
Â  Â  const SUPABASE_KEY = 'sb_publishable_iDFJ6pJRKCbwaE1SQleLMg_mOHD8Q4z';
Â  Â  const supabase = (SUPABASE_URL && SUPABASE_KEY) ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

Â  Â  // --- GUESTBOOK LOGIC ---
Â  Â  function toggleGuestbook() {
Â  Â  Â  Â  const m = document.getElementById('guest-modal');
Â  Â  Â  Â  const isOpening = m.style.display !== 'flex';
Â  Â  Â  Â  m.style.display = isOpening ? 'flex' : 'none';
Â  Â  Â  Â  if(isOpening) loadGuestbook();
Â  Â  }

Â  Â  async function loadGuestbook() {
Â  Â  Â  Â  if(!supabase) {
Â  Â  Â  Â  Â  Â  document.getElementById('guest-list').innerHTML = '<li style="text-align:center; padding:10px;">Supabase not configured.</li>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const { data, error } = await supabase.from('circuitsim').select('*').order('created_at', { ascending: false }).limit(50);
Â  Â  Â  Â  if(error) {
Â  Â  Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  Â  Â  document.getElementById('guest-list').innerHTML = '<li style="color:red">Error loading data.</li>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  renderGuestList(data);
Â  Â  }

Â  Â  function renderGuestList(data) {
Â  Â  Â  Â  const ul = document.getElementById('guest-list');
Â  Â  Â  Â  ul.innerHTML = "";
Â  Â  Â  Â  data.forEach(item => {
Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  li.className = 'guest-item';
Â  Â  Â  Â  Â  Â  const date = new Date(item.created_at).toLocaleDateString();
Â  Â  Â  Â  Â  Â  li.innerHTML = `<span class="guest-time">${date}</span><div class="guest-nick">${escapeHtml(item.nickname)}</div><div class="guest-msg">${escapeHtml(item.message)}</div>`;
Â  Â  Â  Â  Â  Â  ul.appendChild(li);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function addGuestEntry() {
Â  Â  Â  Â  if(!supabase) return alert("Supabase Key Missing");
Â  Â  Â  Â  const nick = document.getElementById('g-nick').value.trim();
Â  Â  Â  Â  const msg = document.getElementById('g-msg').value.trim();
Â  Â  Â  Â  if(!nick || !msg) return alert("Please fill nickname and message.");

Â  Â  Â  Â  const { error } = await supabase.from('circuitsim').insert([{ nickname: nick, message: msg }]);
Â  Â  Â  Â  if(error) {
Â  Â  Â  Â  Â  Â  alert("Error writing: " + error.message);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById('g-msg').value = '';
Â  Â  Â  Â  Â  Â  loadGuestbook(); // Reload list
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- TEXTS ---
Â  Â  let curLang = 'ko';Â 
Â  Â  const texts = {
Â  Â  Â  Â  ko: {
Â  Â  Â  Â  Â  Â  appTitle: "ì´ˆë³´ìë¥¼ ìœ„í•œ ì˜¨ë¼ì¸ íšŒë¡œ ì‹œë®¬ë ˆì´í„°", langBtn: "ğŸŒ English",
Â  Â  Â  Â  Â  Â  t_grid: "ê·¸ë¦¬ë“œ", t_file: "íŒŒì¼", t_mode: "ëª¨ë“œ", t_parts: "ë¶€í’ˆ",
Â  Â  Â  Â  Â  Â  b_save: "ğŸ’¾ ì €ì¥", b_load: "ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°", b_steady: "âš¡ ì •ìƒìƒíƒœ", b_reset: "ì´ˆê¸°í™”",
Â  Â  Â  Â  Â  Â  b_run: "â–¶ ì‹¤í–‰", b_stop: "â¹ ì •ì§€",
Â  Â  Â  Â  Â  Â  resTitle: "ğŸ“Š ì •ìƒìƒíƒœ í•´ì„ ê²°ê³¼", resPlaceholder: "[âš¡ ì •ìƒìƒíƒœ] ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.",
Â  Â  Â  Â  Â  Â  transTitle: "ğŸ“ˆ ê³¼ë„ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜", l_time: "ì‹œê°„",
Â  Â  Â  Â  Â  Â  guideTitle: "ğŸ“˜ ì•± ì‚¬ìš© ê°€ì´ë“œ",
Â  Â  Â  Â  Â  Â  guideItems: ["<b>ì†Œì ì¶”ê°€/ì—°ê²°/ì‚­ì œ:</b> íˆ´ë°” í´ë¦­, ë“œë˜ê·¸, ìš°í´ë¦­.", "<b>ì†ì„± ë³€ê²½:</b> ë”ë¸” í´ë¦­ (ê°’, ì£¼íŒŒìˆ˜, ìœ„ìƒ).", "<b>ì •ìƒìƒíƒœ í•´ì„:</b> íšŒë¡œì˜ ìµœì¢… ì•ˆì • ìƒíƒœ(í¬ê¸°, ìœ„ìƒ) ê³„ì‚°.", "<b>ìˆ˜ì‹ ê³„ì‚°:</b> ì •ìƒìƒíƒœ íŒ¨ë„ì—ì„œ <b>V(N1)*conj(I(R1))</b> ë“±ì„ ì…ë ¥í•˜ì—¬ ì „ë ¥ ë“±ì„ ê³„ì‚°.", "<b>ê³¼ë„ì‘ë‹µ:</b> ì‹œê°„ì— ë”°ë¥¸ ë³€í™”ë¥¼ ê·¸ë˜í”„ë¡œ í™•ì¸.", "<b>FFT:</b> ìš°ì¸¡ í•˜ë‹¨ì—ì„œ ì£¼íŒŒìˆ˜ ë¶„ì„.", "<b>RMS:</b> ì •ìƒìƒíƒœ ê²°ê³¼ì— ì‹¤íš¨ê°’(RMS) í‘œì‹œë¨."],
Â  Â  Â  Â  Â  Â  th_var: "ë³€ìˆ˜/ìˆ˜ì‹", th_mag: "Peak (Mag)", th_rms: "RMS", th_ph: "ìœ„ìƒ (deg)"
Â  Â  Â  Â  },
Â  Â  Â  Â  en: {
Â  Â  Â  Â  Â  Â  appTitle: "Online Circuit Simulator for Beginners", langBtn: "ğŸŒ í•œêµ­ì–´",
Â  Â  Â  Â  Â  Â  t_grid: "GRID", t_file: "FILE", t_mode: "MODE", t_parts: "PARTS",
Â  Â  Â  Â  Â  Â  b_save: "ğŸ’¾ Save", b_load: "ğŸ“‚ Load", b_steady: "âš¡ Steady State", b_reset: "Reset All",
Â  Â  Â  Â  Â  Â  b_run: "â–¶ Run", b_stop: "â¹ Stop",
Â  Â  Â  Â  Â  Â  resTitle: "ğŸ“Š Steady State Result", resPlaceholder: "Press [âš¡ Steady State] to see results.",
Â  Â  Â  Â  Â  Â  transTitle: "ğŸ“ˆ Transient Simulation", l_time: "Time",
Â  Â  Â  Â  Â  Â  guideTitle: "ğŸ“˜ App User Guide",
Â  Â  Â  Â  Â  Â  guideItems: ["<b>Add/Connect/Delete:</b> Toolbar click, drag, right-click.", "<b>Properties:</b> Double-click to edit.", "<b>Steady State:</b> Calculates final Mag/Phase.", "<b>Custom Formula:</b> Type <b>V(N1)*conj(I(R1))</b> to calc power.", "<b>Transient:</b> Time-domain graph.", "<b>FFT:</b> Frequency analysis panel.", "<b>RMS:</b> RMS values are shown in the table."],
Â  Â  Â  Â  Â  Â  th_var: "Variable/Formula", th_mag: "Peak (Mag)", th_rms: "RMS", th_ph: "Phase (deg)"
Â  Â  Â  Â  }
Â  Â  };
Â  Â  function toggleLanguage(){ curLang = (curLang==='ko') ? 'en' : 'ko'; updateText(); }
Â  Â  function updateText(){
Â  Â  Â  Â  const t = texts[curLang]; document.getElementById('app-title').innerText = t.appTitle; document.getElementById('lang-btn').innerText = t.langBtn;
Â  Â  Â  Â  document.querySelectorAll('[data-txt]').forEach(el => { const key = el.getAttribute('data-txt'); if(t[key]) el.innerHTML = t[key]; });
Â  Â  Â  Â  document.getElementById('guide-list').innerHTML = t.guideItems.map(item => `<li>${item}</li>`).join('');
Â  Â  Â  Â  if(steadyResults) renderSteadyResults(); // Refresh table headers
Â  Â  }

Â  Â  // --- SETUP & DRAWING ---
Â  Â  const stage=new Konva.Stage({container:'container',width:100,height:100});
Â  Â  const layer=new Konva.Layer(); stage.add(layer);
Â  Â  let railCount=6; const MAX_RAILS=30; const START_X=230, BASE_W=120;
Â  Â  let groundRails = new Set([1]);Â 
Â  Â  new ResizeObserver(()=>{const c=document.getElementById('container');if(c.offsetWidth>0){stage.width(c.offsetWidth);stage.height(c.offsetHeight);drawGrid();}}).observe(document.getElementById('container'));
Â  Â  function getGridMetrics() { const w=stage.width(), h=stage.height(); let rw=BASE_W; if(START_X+railCount*rw > w-20) rw=(w-START_X-20)/railCount; if(rw<30) rw=30; let compScale = Math.min(1, (rw * 0.9) / 100); return {rw, gndY:h*0.9, compScale}; }
Â  Â  function drawGrid(){
Â  Â  Â  Â  layer.find('.g').forEach(n=>n.destroy()); const {rw, gndY} = getGridMetrics();
Â  Â  Â  Â  layer.add(new Konva.Line({points:[START_X-20, gndY, START_X+railCount*rw, gndY], stroke:'#212529', strokeWidth:3, name:'g'}));
Â  Â  Â  Â  layer.add(new Konva.Text({x:START_X-50, y:gndY+10, text:'0 (GND)', fontStyle:'bold', fill:'#212529', name:'g'}));
Â  Â  Â  Â  for(let i=1; i<=railCount; i++){
Â  Â  Â  Â  Â  Â  const x=START_X+(i-1)*rw; const isG = groundRails.has(i);Â 
Â  Â  Â  Â  Â  Â  const l=new Konva.Line({points:[x,40,x,gndY], stroke: isG ? '#212529' : '#adb5bd', strokeWidth: isG ? 3 : 1, dash: isG ? [] : [4,4], name:'g'});
Â  Â  Â  Â  Â  Â  const grp=new Konva.Group({x:x,y:20,name:'g'});
Â  Â  Â  Â  Â  Â  grp.add(new Konva.Rect({x:-14,y:-10,width:28,height:20,fill:isG?'#343a40':'#fff',stroke:'#ced4da',cornerRadius:10}));
Â  Â  Â  Â  Â  Â  grp.add(new Konva.Text({x:-14,y:-5,width:28,align:'center',text: isG ? `G${i}` : `${i}`, fill: isG ? '#fff' : '#495057', fontSize:10,fontStyle:'bold'}));
Â  Â  Â  Â  Â  Â  grp.on('mouseenter',()=>document.body.style.cursor='pointer'); grp.on('mouseleave',()=>document.body.style.cursor='default');
Â  Â  Â  Â  Â  Â  grp.on('click', () => { if(groundRails.has(i)) groundRails.delete(i); else groundRails.add(i); drawGrid(); });
Â  Â  Â  Â  Â  Â  layer.add(l); layer.add(grp);
Â  Â  Â  Â  }
Â  Â  Â  Â  components.forEach(c=>updateComp(c)); layer.draw();
Â  Â  }
Â  Â  function updateRailCount(d){let n=railCount+d;if(n<2||n>MAX_RAILS)return;railCount=n;drawGrid();}

Â  Â  let components=[], idCnt={R:0,L:0,C:0,V:0,T:0,I:0};
Â  Â  function spawn(type, params=null){Â 
Â  Â  Â  Â  let c;
Â  Â  Â  Â  if(params) { c = { ...params }; c.group = null; c.lineL = null; c.lineR = null; c.labelObj = null; }Â 
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  let cat=type.includes('V')?'V':(type.includes('I')?'I':type.charAt(0)); idCnt[cat]++; const name=cat+idCnt[cat];
Â  Â  Â  Â  Â  Â  c={name,type,val:0,freq:60,phase:0,unit:'',nL:1,nR:2,ratio:1, group:null, lineL:null, lineR:null};
Â  Â  Â  Â  Â  Â  if(type==='R'){c.val=1000;c.unit='Î©';} else if(type==='L'){c.val=10e-3;c.unit='H';} else if(type==='C'){c.val=100e-6;c.unit='F';}
Â  Â  Â  Â  Â  Â  else if(type==='V_DC'){c.val=10;c.unit='V';} else if(type==='V_AC'){c.val=220;c.unit='V';}
Â  Â  Â  Â  Â  Â  else if(type==='I_AC'){c.val=1;c.unit='A';}
Â  Â  Â  Â  Â  Â  else if(type==='T'){c.ratio=1;c.unit='';}
Â  Â  Â  Â  }
Â  Â  Â  Â  const {rw} = getGridMetrics();
Â  Â  Â  Â  let sx = START_X + rw/2; let sy = 100;
Â  Â  Â  Â  if(!params && components.length > 0) { sy += 60; }
Â  Â  Â  Â  const initX = (c.uiX !== undefined) ? c.uiX : sx; const initY = (c.uiY !== undefined) ? c.uiY : sy;
Â  Â  Â  Â  const g=new Konva.Group({x:initX,y:initY,draggable:true});
Â  Â  Â  Â  const wL=new Konva.Line({points:[],stroke:'#000',strokeWidth:2,dash:[2,2],name:'w'});
Â  Â  Â  Â  const wR=new Konva.Line({points:[],stroke:'#000',strokeWidth:2,dash:[2,2],name:'w'});Â 
Â  Â  Â  Â  layer.add(wL); layer.add(wR); c.lineL=wL; c.lineR=wR;
Â  Â  Â  Â  const shape=drawShape(c.type); g.add(shape);
Â  Â  Â  Â  const lbl=new Konva.Text({x:-50,y:-50,width:100,align:'center',fontSize:12,fontStyle:'bold',fill:'#333',text:getLabel(c)});
Â  Â  Â  Â  g.add(lbl); c.labelObj=lbl; c.group=g;
Â  Â  Â  Â  g.on('dragmove',()=>updateComp(c, true));
Â  Â  Â  Â  g.on('dragend',()=>{
Â  Â  Â  Â  Â  Â  c.uiX = g.x(); c.uiY = g.y(); const {rw} = getGridMetrics(); const gx = g.x(); const isVertical = (c.nL === 0 || c.nR === 0);
Â  Â  Â  Â  Â  Â  if(isVertical) {
Â  Â  Â  Â  Â  Â  Â  Â  let idx = Math.round((gx - START_X) / rw) + 1;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(idx < 1) idx = 1; if(idx > railCount) idx = railCount;
Â  Â  Â  Â  Â  Â  Â  Â  if(c.nL === 0) c.nR = idx; else c.nL = idx;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  let leftIdx = Math.round((gx - START_X - rw/2) / rw);Â 
Â  Â  Â  Â  Â  Â  Â  Â  let nLeft = leftIdx + 1; if(nLeft < 1) nLeft = 1; if(nLeft >= railCount) nLeft = railCount - 1;
Â  Â  Â  Â  Â  Â  Â  Â  c.nL = nLeft; c.nR = nLeft + 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateComp(c);
Â  Â  Â  Â  });
Â  Â  Â  Â  g.on('dblclick',()=>{
Â  Â  Â  Â  Â  Â  let def=`${c.nL},${c.nR}`, promptMsg=`[${c.name}] N1, N2`;
Â  Â  Â  Â  Â  Â  if(c.type==='T'){promptMsg+=`, Ratio`;def+=`,${c.ratio}`;} else {promptMsg+=`, Val`;def+=`,${formatUnit(c.val,'').replace(/[a-zA-Z]*$/,'')}`;}
Â  Â  Â  Â  Â  Â  if(c.type.includes('AC')){promptMsg+=`, Freq, Phase(deg)`;def+=`,${c.freq},${c.phase||0}`;}
Â  Â  Â  Â  Â  Â  const ret=prompt(promptMsg, def);
Â  Â  Â  Â  Â  Â  if(ret){
Â  Â  Â  Â  Â  Â  Â  Â  const p=ret.split(','); const newNL=parseInt(p[0]), newNR=parseInt(p[1]);
Â  Â  Â  Â  Â  Â  Â  Â  const nodes = [newNL, newNR].sort((a,b)=>a-b);
Â  Â  Â  Â  Â  Â  Â  Â  if(nodes[0]===0 && nodes[1]===1) return alert("Error: 0-1 connect forbidden");
Â  Â  Â  Â  Â  Â  Â  Â  if(nodes[0]===0 && nodes[1]===railCount) return alert("Error: 0-End connect forbidden");
Â  Â  Â  Â  Â  Â  Â  Â  if(nodes[0]===1 && nodes[1]===railCount) return alert("Error: 1-End connect forbidden");
Â  Â  Â  Â  Â  Â  Â  Â  c.nL=newNL; c.nR=newNR;
Â  Â  Â  Â  Â  Â  Â  Â  if(c.type==='T'){if(p[2])c.ratio=parseFloat(p[2]);} else {if(p[2])c.val=parseUnit(p[2]);Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(c.type.includes('AC')){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(p[3])c.freq=parseUnit(p[3]);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(p[4])c.phase=parseFloat(p[4]); else c.phase=0;
Â  Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  Â  Â  lbl.text(getLabel(c)); updateComp(c); layer.draw();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  g.on('contextmenu',(e)=>{e.evt.preventDefault();if(confirm('Delete?')){g.destroy();c.lineL.destroy();c.lineR.destroy();components=components.filter(x=>x!==c);layer.draw();}});
Â  Â  Â  Â  components.push(c); layer.add(g); updateComp(c); layer.draw();
Â  Â  }

Â  Â  function updateComp(c, dragging=false){
Â  Â  Â  Â  const {rw, gndY, compScale} = getGridMetrics(); const isVertical = (c.nL === 0 || c.nR === 0);
Â  Â  Â  Â  c.group.scale({x: compScale, y: compScale});
Â  Â  Â  Â  if (dragging) { return; }Â 
Â  Â  Â  Â  if (isVertical) {
Â  Â  Â  Â  Â  Â  const targetNode = (c.nL === 0) ? c.nR : c.nL; const tx = START_X + (targetNode-1)*rw;Â 
Â  Â  Â  Â  Â  Â  let ty = c.group.y(); if(ty < 60) ty = 60; if(ty > gndY - 60) ty = gndY - 60;
Â  Â  Â  Â  Â  Â  c.group.rotation(90); c.group.position({x:tx, y:ty});
Â  Â  Â  Â  Â  Â  c.lineL.points([tx, 40, tx, ty - 50*compScale]); c.lineR.points([tx, ty + 50*compScale, tx, gndY]);Â 
Â  Â  Â  Â  Â  Â  c.labelObj.rotation(-90); c.labelObj.absolutePosition({x: tx + 10, y: ty - 6});Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const xL = START_X + (c.nL-1)*rw; const xR = START_X + (c.nR-1)*rw; const cx = (xL + xR) / 2;
Â  Â  Â  Â  Â  Â  c.group.rotation(0); c.group.x(cx);
Â  Â  Â  Â  Â  Â  let cy = c.group.y(); if(cy < 60) cy = 60; if(cy > gndY - 20) cy = gndY - 20;Â 
Â  Â  Â  Â  Â  Â  c.group.y(cy);
Â  Â  Â  Â  Â  Â  c.lineL.points([xL, cy, cx - 50*compScale, cy]); c.lineR.points([cx + 50*compScale, cy, xR, cy]);
Â  Â  Â  Â  Â  Â  c.labelObj.rotation(0); c.labelObj.x(-50); c.labelObj.y(-50);
Â  Â  Â  Â  }
Â  Â  Â  Â  const col=c.type==='T'?'#f08c00':'#333'; c.lineL.stroke(col); c.lineL.dash([4,4]); c.lineR.stroke(col); c.lineR.dash([4,4]);
Â  Â  }

Â  Â  function getLabel(c){
Â  Â  Â  Â  if(c.type==='T') return `${c.name}\n1:${c.ratio}`;
Â  Â  Â  Â  let t=`${c.name}\n${formatUnit(c.val,c.unit)}`;
Â  Â  Â  Â  if(c.type.includes('AC')) t+=`\n${formatUnit(c.freq,'Hz')} âˆ ${c.phase||0}Â°`;
Â  Â  Â  Â  return t;
Â  Â  }

Â  Â  function drawShape(type) {
Â  Â  Â  Â  const g=new Konva.Group({offsetX:50,offsetY:20});
Â  Â  Â  Â  g.add(new Konva.Rect({width:100,height:40,fill:'transparent'}));
Â  Â  Â  Â  const l=(p,w=2,col='#333')=>new Konva.Line({points:p,stroke:col,strokeWidth:w,lineCap:'round',lineJoin:'round'});
Â  Â  Â  Â  const mid=20;
Â  Â  Â  Â  if(type==='R') g.add(l([0,mid, 20,mid, 25,mid-10, 35,mid+10, 45,mid-10, 55,mid+10, 65,mid-10, 75,mid+10, 80,mid, 100,mid]));
Â  Â  Â  Â  else if(type==='L'){ g.add(new Konva.Path({x:20, y:mid, data:`M0,0 Q7,-15 14,0 Q21,-15 28,0 Q35,-15 42,0 Q49,-15 56,0`, stroke:'#333', strokeWidth:2})); g.add(l([0,mid, 20,mid])); g.add(l([76,mid, 100,mid])); }
Â  Â  Â  Â  else if(type==='C'){ g.add(l([0,mid, 45,mid])); g.add(l([55,mid, 100,mid])); g.add(l([45,mid-12, 45,mid+12])); g.add(l([55,mid-12, 55,mid+12])); }
Â  Â  Â  Â  else if(type.includes('V')){
Â  Â  Â  Â  Â  Â  g.add(l([0,mid, 40,mid])); g.add(l([60,mid, 100,mid]));
Â  Â  Â  Â  Â  Â  if(type==='V_DC'){ g.add(l([40,mid-8, 40,mid+8], 3)); g.add(l([60,mid-16, 60,mid+16], 3)); g.add(new Konva.Text({x:65, y:mid-15, text:'+', fontSize:14, fill:'red', fontStyle:'bold'})); }Â 
Â  Â  Â  Â  Â  Â  else { g.add(new Konva.Circle({x:50, y:mid, radius:15, stroke:'#333', strokeWidth:2, fill:'white'})); g.add(new Konva.Path({x:43, y:mid, data:`M0,0 Q3.5,-6 7,0 T14,0`, stroke:'#333', strokeWidth:2})); }
Â  Â  Â  Â  }
Â  Â  Â  Â  else if(type==='I_AC') {
Â  Â  Â  Â  Â  Â  g.add(l([0,mid, 40,mid])); g.add(l([60,mid, 100,mid]));
Â  Â  Â  Â  Â  Â  g.add(new Konva.Circle({x:50, y:mid, radius:15, stroke:'#333', strokeWidth:2, fill:'white'}));
Â  Â  Â  Â  Â  Â  g.add(new Konva.Arrow({points:[60, mid, 40, mid], pointerLength:6, pointerWidth:6, fill:'#333', stroke:'#333', strokeWidth:2}));
Â  Â  Â  Â  }
Â  Â  Â  Â  else if(type==='T') {
Â  Â  Â  Â  Â  Â  g.add(l([48, 5, 48, 35], 2)); g.add(l([52, 5, 52, 35], 2));
Â  Â  Â  Â  Â  Â  g.add(l([0,20, 25,20, 25,10, 35,10], 2));Â 
Â  Â  Â  Â  Â  Â  g.add(new Konva.Path({ data: "M35,10 c-6,0 -6,6 0,6 c-6,0 -6,6 0,6 c-6,0 -6,6 0,6", stroke: '#333', strokeWidth: 2, lineCap: 'round', lineJoin: 'round' }));
Â  Â  Â  Â  Â  Â  g.add(l([35,28, 35,32], 2)); g.add(l([28,32, 42,32], 2)); g.add(l([31,35, 39,35], 2)); g.add(l([34,38, 36,38], 2));
Â  Â  Â  Â  Â  Â  g.add(l([100,20, 75,20, 75,10, 65,10], 2));Â 
Â  Â  Â  Â  Â  Â  g.add(new Konva.Path({ data: "M65,10 c6,0 6,6 0,6 c6,0 6,6 0,6 c6,0 6,6 0,6", stroke: '#333', strokeWidth: 2, lineCap: 'round', lineJoin: 'round' }));
Â  Â  Â  Â  Â  Â  g.add(l([65,28, 65,32], 2)); g.add(l([58,32, 72,32], 2)); g.add(l([61,35, 69,35], 2)); g.add(l([64,38, 66,38], 2));
Â  Â  Â  Â  }
Â  Â  Â  Â  return g;
Â  Â  }

Â  Â  // --- SIMULATION ---
Â  Â  let lastSimResult = null;Â 
Â  Â  let steadyResults = null; // Stores complex results { nodes: [], currents: [] }
Â  Â  let customFormulas = [];

Â  Â  function getSetup(){
Â  Â  Â  Â  if(components.length===0)return alert('No parts');
Â  Â  Â  Â  const map={}; map[0] = -1;Â 
Â  Â  Â  Â  let matrixIdx = 0; const compactMap = {}; compactMap[0] = -1;
Â  Â  Â  Â  for(let i=1; i<=railCount; i++){ if(groundRails.has(i)) compactMap[i] = -1; else compactMap[i] = matrixIdx++; }
Â  Â  Â  Â  return {map: compactMap, N: matrixIdx};
Â  Â  }

Â  Â  function runSteady() {
Â  Â  Â  Â  const s=getSetup(); if(!s)return; const {map,N}=s;
Â  Â  Â  Â  const ac=components.find(c=>c.type.includes('AC')), freq=ac?ac.freq:0, w=2*Math.PI*freq;
Â  Â  Â  Â  const Vs=components.filter(c=>c.type.includes('V')), Ts=components.filter(c=>c.type==='T');
Â  Â  Â  Â  const size=N+Vs.length+Ts.length;
Â  Â  Â  Â  let A=math.zeros(size,size,'dense'), B=math.zeros(size,1,'dense');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const vOff=N, tOff=vOff+Vs.length;
Â  Â  Â  Â  components.forEach(c=>{
Â  Â  Â  Â  Â  Â  const n1=map[c.nL], n2=map[c.nR];
Â  Â  Â  Â  Â  Â  if(['R','L','C'].includes(c.type)) {
Â  Â  Â  Â  Â  Â  Â  Â  let Y = math.complex(0,0);
Â  Â  Â  Â  Â  Â  Â  Â  if(c.type==='R') Y=math.complex(1/c.val,0);
Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type==='L') Y=(w===0)?math.complex(1e9,0):math.complex(0, -1/(w*c.val));
Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type==='C') Y=(w===0)?math.complex(0,0):math.complex(0, w*c.val);
Â  Â  Â  Â  Â  Â  Â  Â  if(n1>=0) A.set([n1,n1],math.add(A.get([n1,n1]),Y));
Â  Â  Â  Â  Â  Â  Â  Â  if(n2>=0) A.set([n2,n2],math.add(A.get([n2,n2]),Y));
Â  Â  Â  Â  Â  Â  Â  Â  if(n1>=0&&n2>=0){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nY=math.multiply(Y,-1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  A.set([n1,n2],math.add(A.get([n1,n2]),nY));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  A.set([n2,n1],math.add(A.get([n2,n1]),nY));Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else if(c.type.includes('V')) {
Â  Â  Â  Â  Â  Â  Â  Â  const idx=vOff+Vs.indexOf(c);
Â  Â  Â  Â  Â  Â  Â  Â  if(n2>=0){A.set([n2,idx],1);A.set([idx,n2],1);} if(n1>=0){A.set([n1,idx],-1);A.set([idx,n1],-1);}
Â  Â  Â  Â  Â  Â  Â  Â  const phi = (c.phase || 0) * Math.PI / 180;
Â  Â  Â  Â  Â  Â  Â  Â  B.set([idx,0], math.complex(c.val * Math.cos(phi), c.val * Math.sin(phi)));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else if(c.type === 'I_AC') {
Â  Â  Â  Â  Â  Â  Â  Â  const phi = (c.phase || 0) * Math.PI / 180;
Â  Â  Â  Â  Â  Â  Â  Â  const I = math.complex(c.val * Math.cos(phi), c.val * Math.sin(phi));
Â  Â  Â  Â  Â  Â  Â  Â  if(n1>=0) B.set([n1,0], math.add(B.get([n1,0]), I));
Â  Â  Â  Â  Â  Â  Â  Â  if(n2>=0) B.set([n2,0], math.subtract(B.get([n2,0]), I));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else if(c.type==='T') {
Â  Â  Â  Â  Â  Â  Â  Â  const idx=tOff+Ts.indexOf(c);
Â  Â  Â  Â  Â  Â  Â  Â  if(n2>=0){A.set([n2,idx],1);A.set([idx,n2],1);} if(n1>=0){A.set([n1,idx],-c.ratio);A.set([idx,n1],-c.ratio);}
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const X=math.lusolve(A,B);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Store Results properly for custom calc
Â  Â  Â  Â  Â  Â  steadyResults = { nodes: {}, currents: {} };
Â  Â  Â  Â  Â  Â  const invMap = {}; Object.keys(map).forEach(k=>{if(map[k]>=0)invMap[map[k]]=k;});

Â  Â  Â  Â  Â  Â  // Store Nodes
Â  Â  Â  Â  Â  Â  for(let i=0;i<N;i++){
Â  Â  Â  Â  Â  Â  Â  Â  steadyResults.nodes[`N${invMap[i]}`] = X.get([i,0]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Add Ground (N0)
Â  Â  Â  Â  Â  Â  steadyResults.nodes[`N0`] = math.complex(0,0);

Â  Â  Â  Â  Â  Â  // Store Currents
Â  Â  Â  Â  Â  Â  components.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  let I = math.complex(0,0);
Â  Â  Â  Â  Â  Â  Â  Â  const n1=map[c.nL], n2=map[c.nR];
Â  Â  Â  Â  Â  Â  Â  Â  const v1 = n1>=0 ? X.get([n1,0]) : math.complex(0,0);
Â  Â  Â  Â  Â  Â  Â  Â  const v2 = n2>=0 ? X.get([n2,0]) : math.complex(0,0);
Â  Â  Â  Â  Â  Â  Â  Â  const V_drop = math.subtract(v1, v2);
Â  Â  Â  Â  Â  Â  Â  Â  if(c.type === 'R') { I = math.divide(V_drop, c.val); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type === 'L') { const Z = math.complex(0, w*c.val); I = (w===0)?math.complex(1e9,0):math.divide(V_drop, Z); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type === 'C') { const Z = (w===0)?math.complex(1e9,0):math.complex(0, -1/(w*c.val)); I = math.divide(V_drop, Z); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type.includes('V')) { I = X.get([vOff + Vs.indexOf(c), 0]); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type === 'I_AC') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const phi = (c.phase || 0) * Math.PI / 180;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  I = math.complex(c.val * Math.cos(phi), c.val * Math.sin(phi));Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type === 'T') { I = X.get([tOff + Ts.indexOf(c), 0]); }
Â  Â  Â  Â  Â  Â  Â  Â  steadyResults.currents[c.name] = I;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  renderSteadyResults();

Â  Â  Â  Â  } catch(e){
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  document.getElementById('res-content').innerHTML='Matrix Error (Singular?)';Â 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function renderSteadyResults() {
Â  Â  Â  Â  if(!steadyResults) return;
Â  Â  Â  Â  const t=texts[curLang];
Â  Â  Â  Â  let h=`<table class="res-table"><tr><th>${t.th_var}</th><th>${t.th_mag}</th><th>${t.th_rms}</th><th>${t.th_ph}</th><th></th></tr>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Helper to format row
Â  Â  Â  Â  const row = (lbl, val) => {
Â  Â  Â  Â  Â  Â  let cmplx = (val && val.re!==undefined) ? val : math.complex(val||0);
Â  Â  Â  Â  Â  Â  let p = cmplx.toPolar();
Â  Â  Â  Â  Â  Â  let rms = p.r / Math.SQRT2;
Â  Â  Â  Â  Â  Â  return `<tr><td>${lbl}</td><td>${formatUnit(p.r,'')}</td><td>${formatUnit(rms,'')}</td><td>${(p.phi*180/Math.PI).toFixed(1)}Â°</td><td></td></tr>`;
Â  Â  Â  Â  };

Â  Â  Â  Â  // Standard Rows
Â  Â  Â  Â  Object.keys(steadyResults.nodes).sort().forEach(k => {
Â  Â  Â  Â  Â  Â  if(k!=='N0') h += row(`V(${k})`, steadyResults.nodes[k]);
Â  Â  Â  Â  });
Â  Â  Â  Â  Object.keys(steadyResults.currents).forEach(k => {
Â  Â  Â  Â  Â  Â  h += row(`I(${k})`, steadyResults.currents[k]);
Â  Â  Â  Â  });

Â  Â  Â  Â  // Custom Formulas
Â  Â  Â  Â  if(customFormulas.length > 0) {
Â  Â  Â  Â  Â  Â  // Prepare Math Scope
Â  Â  Â  Â  Â  Â  const scope = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  ...steadyResults.nodes, // N1, N2... (Direct complex values if user types N1)
Â  Â  Â  Â  Â  Â  Â  Â  ...steadyResults.currents, // R1, L1... (Direct current values if user types R1? No, usually I(R1))
Â  Â  Â  Â  Â  Â  Â  Â  // Add aliases for ease of use
Â  Â  Â  Â  Â  Â  Â  Â  real: math.re, imaginary: math.im, absolute: math.abs,
Â  Â  Â  Â  Â  Â  Â  Â  // Functions V(node) and I(comp)
Â  Â  Â  Â  Â  Â  Â  Â  V: function(n) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Handle V("N1") or V(N1) where N1 is passed as val
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let key = n;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(typeof n !== 'string') { // If passed as variable, find key? Hard.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Instead, let's assume user passes string "N1" or variable N1 which is defined in scope?
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Actually, easier: define scope.N1 = "N1".
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return steadyResults.nodes[key] || math.complex(0,0);
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  I: function(c) { return steadyResults.currents[c] || math.complex(0,0); }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  // Add Node/Comp names as strings to scope so V(N1) works (N1 is var "N1")
Â  Â  Â  Â  Â  Â  Object.keys(steadyResults.nodes).forEach(k => scope[k] = k);
Â  Â  Â  Â  Â  Â  Object.keys(steadyResults.currents).forEach(k => scope[k] = k);

Â  Â  Â  Â  Â  Â  customFormulas.forEach((fmt, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const res = math.evaluate(fmt, scope);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h += `<tr class="custom-row"><td>${fmt}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Check if result is number or complex
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let cmplx = (typeof res === 'object' && res.re!==undefined) ? res : math.complex(res);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let p = cmplx.toPolar();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let rms = p.r / Math.SQRT2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h += `<td>${formatUnit(p.r,'')}</td><td>${formatUnit(rms,'')}</td><td>${(p.phi*180/Math.PI).toFixed(3)}Â°</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h += `<td><button class="btn-del-row" onclick="removeCustomFormula(${idx})">Ã—</button></td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  h += `<tr class="custom-row"><td>${fmt}</td><td colspan="3" style="color:red">Error</td><td><button class="btn-del-row" onclick="removeCustomFormula(${idx})">Ã—</button></td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('res-content').innerHTML=h+`</table>`;
Â  Â  }

Â  Â  function addCustomFormula() {
Â  Â  Â  Â  const inp = document.getElementById('formula-inp');
Â  Â  Â  Â  const val = inp.value.trim();
Â  Â  Â  Â  if(!val) return;
Â  Â  Â  Â  customFormulas.push(val);
Â  Â  Â  Â  inp.value = '';
Â  Â  Â  Â  if(steadyResults) renderSteadyResults();
Â  Â  Â  Â  else alert("Run Steady State analysis first to verify formula.");
Â  Â  }
Â  Â  function removeCustomFormula(idx) {
Â  Â  Â  Â  customFormulas.splice(idx, 1);
Â  Â  Â  Â  renderSteadyResults();
Â  Â  }

Â  Â  // --- (Transient, Graph, FFT functions remain same as v44) ---
Â  Â  // ... [Copy rest of the functions from previous answer: startSimulation, drawChart, updateFFTSources, performFFT, etc.] ...
Â  Â  let abortSim=false;
Â  Â  function stopSimulation(){abortSim=true;document.getElementById('progress-overlay').style.display='none';}
Â  Â  function autoSetParams(){
Â  Â  Â  Â  let f=60; const ac=components.filter(c=>c.type.includes('AC')); if(ac.length>0)f=Math.max(...ac.map(c=>c.freq));
Â  Â  Â  Â  const T=1/f; let tMax=3*T, dt=T/200; if(tMax/dt>5000)dt=tMax/5000;
Â  Â  Â  Â  let u='s'; if(tMax<1e-6)u='us'; else if(tMax<1e-3)u='ms';
Â  Â  Â  Â  const sc=(u==='us')?1e6:(u==='ms')?1e3:1;
Â  Â  Â  Â  document.getElementById('timeUnit').value=u; document.getElementById('xMax').value=(tMax*sc).toFixed(1);
Â  Â  Â  Â  document.getElementById('xMin').value=0; document.getElementById('dtInput').value=formatEng(dt);
Â  Â  Â  Â  alert(`Auto: ${formatUnit(f,'Hz')}, dt=${formatEng(dt)}`);
Â  Â  }

Â  Â  async function startSimulation() {
Â  Â  Â  Â  const s=getSetup(); if(!s)return; const {map,N}=s;
Â  Â  Â  Â  const dt=parseUnit(document.getElementById('dtInput').value);
Â  Â  Â  Â  if(isNaN(dt)||dt<=0)return alert("Invalid dt");
Â  Â  Â  Â  const u=document.getElementById('timeUnit').value, sc=(u==='ps')?1e-12:(u==='us')?1e-6:(u==='ms')?1e-3:1;
Â  Â  Â  Â  const tMin=parseFloat(document.getElementById('xMin').value)*sc, tMax=parseFloat(document.getElementById('xMax').value)*sc;
Â  Â  Â  Â  const steps=Math.floor(tMax/dt);
Â  Â  Â  Â  if(steps>100000 && !confirm(`Points: ${steps}. Continue?`)) return;

Â  Â  Â  Â  abortSim=false;
Â  Â  Â  Â  const pOv=document.getElementById('progress-overlay'), pFill=document.getElementById('p-fill'), pTxt=document.getElementById('status-text');
Â  Â  Â  Â  pOv.style.display='flex'; pFill.style.width='0%'; pTxt.innerText='Init...';

Â  Â  Â  Â  const Ls=components.filter(c=>c.type==='L'), Vs=components.filter(c=>c.type.includes('V'));
Â  Â  Â  Â  const Is=components.filter(c=>c.type==='I_AC');
Â  Â  Â  Â  const Cs=components.filter(c=>c.type==='C'), Ts=components.filter(c=>c.type==='T');
Â  Â  Â  Â  const size=N+Ls.length+Vs.length+Ts.length;
Â  Â  Â  Â  let x=math.zeros(size,1);
Â  Â  Â  Â  const c_prev_V=[], c_prev_I=[], l_prev_V=[], l_prev_I=[];
Â  Â  Â  Â  Cs.forEach(()=>{c_prev_V.push(0);c_prev_I.push(0)}); Ls.forEach(()=>{l_prev_V.push(0);l_prev_I.push(0)});

Â  Â  Â  Â  let A=math.zeros(size,size);
Â  Â  Â  Â  const lOff=N, vOff=N+Ls.length, tOff=vOff+Vs.length;
Â  Â  Â  Â  const addA=(r,c,v)=>{if(r>=0&&c>=0)A.set([r,c],A.get([r,c])+v)};

Â  Â  Â  Â  components.forEach(c=>{
Â  Â  Â  Â  Â  Â  const n1=map[c.nL], n2=map[c.nR];
Â  Â  Â  Â  Â  Â  if(c.type==='R'){ const g=1/c.val; addA(n1,n1,g); addA(n2,n2,g); addA(n1,n2,-g); addA(n2,n1,-g); }
Â  Â  Â  Â  Â  Â  else if(c.type==='C'){ const g=(2*c.val)/dt; addA(n1,n1,g); addA(n2,n2,g); addA(n1,n2,-g); addA(n2,n1,-g); }
Â  Â  Â  Â  Â  Â  else if(c.type==='L'){ const idx=lOff+Ls.indexOf(c), r=(2*c.val)/dt; if(n1>=0){A.set([n1,idx],1);A.set([idx,n1],1);} if(n2>=0){A.set([n2,idx],-1);A.set([idx,n2],-1);} A.set([idx,idx],-r); }
Â  Â  Â  Â  Â  Â  else if(c.type.includes('V')){ const idx=vOff+Vs.indexOf(c); if(n2>=0){A.set([n2,idx],1);A.set([idx,n2],1);} if(n1>=0){A.set([n1,idx],-1);A.set([idx,n1],-1);} }
Â  Â  Â  Â  Â  Â  else if(c.type==='T'){ const idx=tOff+Ts.indexOf(c); if(n2>=0){A.set([n2,idx],1);A.set([idx,n2],1);} if(n1>=0){A.set([n1,idx],-c.ratio);A.set([idx,n1],-c.ratio);} }
Â  Â  Â  Â  });

Â  Â  Â  Â  const resV=Array(N).fill(0).map(()=>[]), resI=[];
Â  Â  Â  Â  components.forEach(c=>resI.push([]));
Â  Â  Â  Â  const timeLog=[]; const chunk=500;

Â  Â  Â  Â  for(let s=0; s<steps; s++){
Â  Â  Â  Â  Â  Â  if(abortSim) break;
Â  Â  Â  Â  Â  Â  const t=s*dt;
Â  Â  Â  Â  Â  Â  if(s%chunk===0){ pFill.style.width=`${(s/steps)*100}%`; pTxt.innerText=`${Math.round(s/steps*100)}%`; await new Promise(r=>setTimeout(r,0)); }

Â  Â  Â  Â  Â  Â  let B=math.zeros(size,1); const addB=(r,v)=>{if(r>=0)B.set([r,0],B.get([r,0])+v)};
Â  Â  Â  Â  Â  Â  Cs.forEach((c,i)=>{const n1=map[c.nL], n2=map[c.nR]; const G=(2*c.val)/dt; const I_inj=G*c_prev_V[i]+c_prev_I[i]; addB(n1,I_inj); addB(n2,-I_inj);});
Â  Â  Â  Â  Â  Â  Ls.forEach((c,i)=>{const idx=lOff+i, R=(2*c.val)/dt, v_eq = -l_prev_V[i] - R*l_prev_I[i]; B.set([idx,0], v_eq);});
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Transient Sources
Â  Â  Â  Â  Â  Â  Vs.forEach((c,i)=>{
Â  Â  Â  Â  Â  Â  Â  Â  const idx=vOff+i; let v=c.val;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(c.type==='V_AC') v *= Math.sin(2*Math.PI*c.freq*t + (c.phase||0)*Math.PI/180);Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if(t<0) v=0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  B.set([idx,0], v);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Is.forEach((c)=>{
Â  Â  Â  Â  Â  Â  Â  Â  let val = c.val * Math.sin(2*Math.PI*c.freq*t + (c.phase||0)*Math.PI/180);
Â  Â  Â  Â  Â  Â  Â  Â  if(map[c.nL]>=0) B.set([map[c.nL],0], B.get([map[c.nL],0]) + val);
Â  Â  Â  Â  Â  Â  Â  Â  if(map[c.nR]>=0) B.set([map[c.nR],0], B.get([map[c.nR],0]) - val);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  x=math.lusolve(A,B);
Â  Â  Â  Â  Â  Â  Â  Â  Cs.forEach((c,i)=>{const v1=map[c.nL]>=0?x.get([map[c.nL],0]):0, v2=map[c.nR]>=0?x.get([map[c.nR],0]):0, v=v1-v2; const G=(2*c.val)/dt, i_new = -c_prev_I[i] + G*(v - c_prev_V[i]); c_prev_V[i]=v; c_prev_I[i]=i_new;});
Â  Â  Â  Â  Â  Â  Â  Â  Ls.forEach((c,i)=>{const i_new=x.get([lOff+i,0]), v1=map[c.nL]>=0?x.get([map[c.nL],0]):0, v2=map[c.nR]>=0?x.get([map[c.nR],0]):0; l_prev_I[i]=i_new; l_prev_V[i]=v1-v2;});
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(t>=tMin){Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeLog.push(t);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let i=0;i<N;i++) resV[i].push(x.get([i,0]));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  components.forEach((c, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let iVal = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(c.type==='R') { const v1=map[c.nL]>=0?x.get([map[c.nL],0]):0, v2=map[c.nR]>=0?x.get([map[c.nR],0]):0; iVal = (v1-v2)/c.val; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type==='C') iVal = c_prev_I[Cs.indexOf(c)];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type==='L') iVal = l_prev_I[Ls.indexOf(c)];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type.includes('V')) iVal = x.get([vOff+Vs.indexOf(c), 0]);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type==='I_AC') iVal = c.val * Math.sin(2*Math.PI*c.freq*t + (c.phase||0)*Math.PI/180);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(c.type==='T') iVal = x.get([tOff+Ts.indexOf(c), 0]);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resI[idx].push(iVal);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch(e){break;}
Â  Â  Â  Â  }
Â  Â  Â  Â  pOv.style.display='none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  lastSimResult = { dt, resV, resI, N, map };
Â  Â  Â  Â  drawChart(timeLog, resV, resI, N, map, sc, u);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Auto update FFT if possible
Â  Â  Â  Â  updateFFTSources();
Â  Â  Â  Â  performFFT();
Â  Â  }

Â  Â  let myChart=null;
Â  Â  function drawChart(times, vData, iData, N, map, scale, unitStr) {
Â  Â  Â  Â  const ctx=document.getElementById('myChart').getContext('2d');
Â  Â  Â  Â  if(myChart) myChart.destroy();
Â  Â  Â  Â  const labels=times.map(t=>(t/scale).toFixed(3));
Â  Â  Â  Â  const sets=[]; const cols=['#e03131','#1971c2','#2f9e44','#f08c00','#9c36b5'];
Â  Â  Â  Â  const invMap = {}; Object.keys(map).forEach(k => { if(map[k] >= 0) invMap[map[k]] = k; });

Â  Â  Â  Â  for(let i=0;i<N;i++){
Â  Â  Â  Â  Â  Â  sets.push({ label:`V(N${invMap[i]})`, data:vData[i], borderColor:cols[i%cols.length], borderWidth:2, pointRadius:0, yAxisID: 'y' });
Â  Â  Â  Â  }
Â  Â  Â  Â  components.forEach((c, idx) => {
Â  Â  Â  Â  Â  Â  const hidden = !(c.type.includes('V') || c.type==='L' || c.type==='I_AC');
Â  Â  Â  Â  Â  Â  sets.push({ label:`I(${c.name})`, data:iData[idx], borderColor: '#868e96', borderWidth:1.5, borderDash: [5, 5], pointRadius:0, hidden: true, yAxisID: 'y' });
Â  Â  Â  Â  });

Â  Â  Â  Â  const yMax=document.getElementById('yMax').value;
Â  Â  Â  Â  myChart=new Chart(ctx,{
Â  Â  Â  Â  Â  Â  type:'line',data:{labels,datasets:sets},
Â  Â  Â  Â  Â  Â  options:{
Â  Â  Â  Â  Â  Â  Â  Â  responsive:true,maintainAspectRatio:false,animation:false,
Â  Â  Â  Â  Â  Â  Â  Â  scales:{ x:{title:{display:true,text:`Time (${unitStr})`},ticks:{maxTicksLimit:8}}, y:{min:yMax?-yMax:undefined,max:yMax?yMax:undefined, title:{display:true, text:'Voltage (V) / Current (A)'}} },
Â  Â  Â  Â  Â  Â  Â  Â  plugins: { legend: { labels: { usePointStyle: true, boxWidth: 6 } } }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  let fftChart = null;

Â  Â  function updateFFTSources() {
Â  Â  Â  Â  const sel = document.getElementById('fft-src');
Â  Â  Â  Â  sel.innerHTML = "";
Â  Â  Â  Â  if(!lastSimResult) return;
Â  Â  Â  Â  const { map, N } = lastSimResult;
Â  Â  Â  Â  const invMap = {}; Object.keys(map).forEach(k => { if(map[k] >= 0) invMap[map[k]] = k; });

Â  Â  Â  Â  for(let i=0; i<N; i++) {
Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  opt.value = `v:${i}`; opt.text = `V(N${invMap[i]})`;
Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  }
Â  Â  Â  Â  components.forEach((c, idx) => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  opt.value = `i:${idx}`; opt.text = `I(${c.name})`;
Â  Â  Â  Â  Â  Â  if(c.type.includes('V') || c.type === 'L') sel.appendChild(opt);Â 
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function performFFT() {
Â  Â  Â  Â  const placeholder = document.getElementById('fft-placeholder');
Â  Â  Â  Â  if(!lastSimResult) {
Â  Â  Â  Â  Â  Â  placeholder.style.display = 'block';
Â  Â  Â  Â  Â  Â  if(fftChart) fftChart.clear();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  placeholder.style.display = 'none';

Â  Â  Â  Â  const { dt, resV, resI } = lastSimResult;
Â  Â  Â  Â  const val = document.getElementById('fft-src').value;
Â  Â  Â  Â  if(!val) return;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  let fMin = parseFloat(document.getElementById('fft-min').value);
Â  Â  Â  Â  let fMax = parseFloat(document.getElementById('fft-max').value);
Â  Â  Â  Â  if(isNaN(fMin) || fMin < 0) fMin = 0;
Â  Â  Â  Â  if(isNaN(fMax) || fMax <= fMin) fMax = fMin + 1000;

Â  Â  Â  Â  const [type, idxStr] = val.split(':');
Â  Â  Â  Â  const idx = parseInt(idxStr);
Â  Â  Â  Â  const data = (type === 'v') ? resV[idx] : resI[idx];
Â  Â  Â  Â Â 
Â  Â  Â  Â  let spectrum = SimpleFFT.calculateSpectrum(data, dt);
Â  Â  Â  Â  spectrum = spectrum.filter(s => s.x >= fMin && s.x <= fMax);

Â  Â  Â  Â  const sorted = [...spectrum].sort((a,b) => b.y - a.y).slice(0, 10);
Â  Â  Â  Â  const tbody = document.getElementById('peak-tbody');
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  sorted.forEach((p, i) => {
Â  Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  Â  tr.innerHTML = `<td>${i+1}</td><td>${p.x.toFixed(3)}</td><td>${p.y.toExponential(3)}</td>`;
Â  Â  Â  Â  Â  Â  tr.onclick = () => highlightBar(p.x);
Â  Â  Â  Â  Â  Â  tr.id = `peak-row-${p.x.toFixed(3).replace('.','_')}`;
Â  Â  Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const ctx = document.getElementById('fftChart').getContext('2d');
Â  Â  Â  Â  if(fftChart) fftChart.destroy();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const labels = spectrum.map(s => s.x.toFixed(1));
Â  Â  Â  Â  const mags = spectrum.map(s => s.y);

Â  Â  Â  Â  fftChart = new Chart(ctx, {
Â  Â  Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'Magnitude',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: mags,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: (ctx) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const idx = ctx.dataIndex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const labelFreq = ctx.chart.data.labels[idx];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return selectedFreq === labelFreq ? '#e03131' : '#862e9c';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  barPercentage: 1.0, categoryPercentage: 1.0
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  responsive: true, maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: { title: { display: true, text: 'Freq (Hz)' }, ticks: { maxTicksLimit: 10 } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: { title: { display: true, text: 'Mag' } }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  onClick: (e, els) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(els.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const idx = els[0].index;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const freq = labels[idx];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  highlightBar(freq);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tooltip: { callbacks: { label: (ctx) => `Mag: ${ctx.raw.toExponential(3)}` } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: false }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  let selectedFreq = null;
Â  Â  function highlightBar(freq) {
Â  Â  Â  Â  selectedFreq = typeof freq === 'number' ? freq.toFixed(1) : freq;
Â  Â  Â  Â  if(fftChart) fftChart.update();
Â  Â  Â  Â  document.querySelectorAll('.peak-table tr').forEach(tr => tr.classList.remove('peak-row-active'));
Â  Â  Â  Â  const rowId = `peak-row-${selectedFreq.replace('.','_')}`;
Â  Â  Â  Â  const row = document.getElementById(rowId);
Â  Â  Â  Â  if(row) {
Â  Â  Â  Â  Â  Â  row.classList.add('peak-row-active');
Â  Â  Â  Â  Â  Â  row.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function exportData(){
Â  Â  Â  Â  if(!myChart)return alert('No Data');
Â  Â  Â  Â  let c="Time"; myChart.data.datasets.forEach(d=>c+=`,${d.label}`); c+="\n";
Â  Â  Â  Â  for(let i=0;i<myChart.data.labels.length;i++){c+=myChart.data.labels[i]; myChart.data.datasets.forEach(d=>c+=`,${d.data[i]}`); c+="\n";}
Â  Â  Â  Â  const b=new Blob([c],{type:'text/csv'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='sim.csv'; a.click();
Â  Â  }
// [1] ìƒˆë¡œìš´ í•¨ìˆ˜ ì¶”ê°€: í˜„ì¬ ë¶€í’ˆë“¤ì˜ ë²ˆí˜¸ë¥¼ ìŠ¤ìº”í•˜ì—¬ ì¹´ìš´í„° ê°•ì œ ë™ê¸°í™”
Â  Â  function refreshIdCounters() {
Â  Â  Â  Â  // 1. ì¹´ìš´í„° ì´ˆê¸°í™”
Â  Â  Â  Â  idCnt = {R:0, L:0, C:0, V:0, T:0, I:0};

Â  Â  Â  Â  // 2. í˜„ì¬ í™”ë©´ì— ìˆëŠ” ëª¨ë“  ë¶€í’ˆ ìˆœíšŒ
Â  Â  Â  Â  components.forEach(c => {
Â  Â  Â  Â  Â  Â  // ì´ë¦„ì—ì„œ ì²« ê¸€ì(ì•ŒíŒŒë²³)ì™€ ë’· ìˆ«ì ë¶„ë¦¬ (ì˜ˆ: R12 -> cat='R', num=12)
Â  Â  Â  Â  Â  Â  const match = c.name.match(/^([a-zA-Z]+)(\d+)$/);
Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  const prefix = match[1]; // R, L, C, V, I, T
Â  Â  Â  Â  Â  Â  Â  Â  const num = parseInt(match[2], 10);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ì¹´í…Œê³ ë¦¬ ë§¤í•‘ (V_DC, V_AC ë“±ì€ Vë¡œ ì‹œì‘í•˜ë¯€ë¡œ ìë™ìœ¼ë¡œ Vë¡œ ì¡í˜)
Â  Â  Â  Â  Â  Â  Â  Â  // í•˜ì§€ë§Œ ì½”ë“œìƒ idCnt í‚¤ëŠ” R, L, C, V, T, I ë¡œ ê´€ë¦¬ë¨.
Â  Â  Â  Â  Â  Â  Â  Â  // ë”°ë¼ì„œ prefixê°€ idCntì˜ í‚¤ì— ìˆëŠ”ì§€ í™•ì¸
Â  Â  Â  Â  Â  Â  Â  Â  let catKey = prefix;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ë§Œì•½ prefixê°€ idCntì— ì—†ë‹¤ë©´ (ì˜ˆ: V_AC ë“± ë³µì¡í•œ ê²½ìš° ëŒ€ë¹„) ê¸°ì¡´ spawn ë¡œì§ í™œìš©
Â  Â  Â  Â  Â  Â  Â  Â  if (idCnt[catKey] === undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (c.type.includes('V')) catKey = 'V';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â else if (c.type.includes('I')) catKey = 'I';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â else catKey = c.type.charAt(0);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì¹´ìš´í„°ê°€ í˜„ì¬ ë¶€í’ˆ ë²ˆí˜¸ë³´ë‹¤ ì‘ìœ¼ë©´ ì—…ë°ì´íŠ¸
Â  Â  Â  Â  Â  Â  Â  Â  if (idCnt[catKey] !== undefined && idCnt[catKey] < num) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  idCnt[catKey] = num;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log("ID Counters Refreshed:", idCnt); // ë””ë²„ê¹…ìš© ë¡œê·¸
Â  Â  }
Â  Â 
Â function saveCircuit(){ if(components.length===0) return alert("Empty"); const data = {railCount,groundRails:Array.from(groundRails),components:components.map(c=>({name:c.name,type:c.type,val:c.val,freq:c.freq,phase:c.phase,unit:c.unit,nL:c.nL,nR:c.nR,ratio:c.ratio,uiX:c.group.x(),uiY:c.group.y()}))}; const b=new Blob([JSON.stringify(data)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='circuit.json'; a.click(); }
Â  Â  // [2] loadCircuit í•¨ìˆ˜ ìˆ˜ì •: ë¡œë“œ ì™„ë£Œ í›„ refreshIdCounters í˜¸ì¶œ
Â  Â  function loadCircuit(input){Â 
Â  Â  Â  Â  const f=input.files[0];Â 
Â  Â  Â  Â  if(!f) return;Â 
Â  Â  Â  Â  const r=new FileReader();Â 
Â  Â  Â  Â  r.onload=(e)=>{
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  const d=JSON.parse(e.target.result);Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. ì´ˆê¸°í™”
Â  Â  Â  Â  Â  Â  Â  Â  resetAll();Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. ì„¤ì • ë° ë¶€í’ˆ ìƒì„±
Â  Â  Â  Â  Â  Â  Â  Â  railCount=d.railCount||6;Â 
Â  Â  Â  Â  Â  Â  Â  Â  groundRails=new Set(d.groundRails||[1]);Â 
Â  Â  Â  Â  Â  Â  Â  Â  d.components.forEach(c=>spawn(c.type,c));Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 3. [í•µì‹¬] ëª¨ë“  ë¶€í’ˆì´ ë¡œë“œëœ í›„, ì¹´ìš´í„° ì¬ì„¤ì • í•¨ìˆ˜ í˜¸ì¶œ
Â  Â  Â  Â  Â  Â  Â  Â  refreshIdCounters();

Â  Â  Â  Â  Â  Â  Â  Â  drawGrid();
Â  Â  Â  Â  Â  Â  }catch(err){
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Err");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };Â 
Â  Â  Â  Â  r.readAsText(f);Â 
Â  Â  Â  Â  input.value='';Â 
Â  Â  }
Â  Â  function resetAll(){Â 
Â  Â  Â  Â  components.forEach(c=>{c.group.destroy();c.lineL.destroy();c.lineR.destroy();});Â 
Â  Â  Â  Â  components=[]; idCnt={R:0,L:0,C:0,V:0,T:0,I:0}; railCount=6; groundRails=new Set([1]); drawGrid();Â 
Â  Â  Â  Â  document.getElementById('res-content').innerHTML = `<div style="color:#888;font-size:11px;text-align:center;padding-top:40px;">${texts[curLang].resPlaceholder}</div>`;Â 
Â  Â  Â  Â  if(myChart){myChart.destroy();myChart=null;}Â 
Â  Â  Â  Â  lastSimResult = null; steadyResults = null; customFormulas = [];
Â  Â  Â  Â  document.getElementById('fft-src').innerHTML = "";
Â  Â  Â  Â  if(fftChart) fftChart.clear();
Â  Â  Â  Â  document.getElementById('peak-tbody').innerHTML = "";
Â  Â  Â  Â  document.getElementById('fft-placeholder').style.display = 'block';
Â  Â  }

Â  Â  updateText();
</script>
</body>
</html> 
