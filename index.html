<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Circuit v47 (Guestbook Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* BASE STYLES */
        body { margin: 0; padding: 0; overflow: hidden; background: #f8f9fa; font-family: 'Segoe UI', sans-serif; user-select: none; display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 3px; }
        
        /* HEADER */
        #main-header { height: 45px; background: #343a40; color: white; display: flex; align-items: center; padding: 0 15px; flex-shrink: 0; position: relative; justify-content: space-between; }
        #app-title { font-size: 16px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .header-btns { display: flex; gap: 8px; }
        .header-btn { background: #495057; color: white; border: 1px solid #adb5bd; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .header-btn:hover { background: #6c757d; }

        /* LAYOUT (Desktop Default) */
        #app { display: flex; flex: 1; width: 100%; overflow: hidden; }
        .pane { display: flex; flex-direction: column; overflow: hidden; }
        
        #left-pane { flex: 6; border-right: 4px solid #dee2e6; position: relative; } 
        #right-pane { flex: 4; background: #fff; } 

        #container { flex: 1; background: #f1f3f5; position: relative; overflow: hidden; }
        
        /* Floating Controls */
        #canvas-controls { position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 10; }
        .ctrl-group { background: rgba(255,255,255,0.9); padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center; }
        .float-btn { width: 28px; height: 28px; border: 1px solid #ced4da; background: white; border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 14px; }
        
        /* Toolbar */
        #toolbar { position: absolute; top: 10px; left: 10px; width: 50px; background: rgba(255,255,255,0.95); padding: 5px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 20; display: flex; flex-direction: column; gap: 4px; max-height: 90%; overflow-y: auto; }
        .tool-btn { width: 40px; height: 36px; border: 1px solid #ced4da; background: #fff; border-radius: 4px; cursor: pointer; font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.1s; }
        .tool-btn:active { background: #e7f5ff; border-color: #339af0; transform: scale(0.95); }
        .badge { color: #333; }

        /* Panels */
        #result-panel { height: 180px; background: white; border-top: 4px solid #dee2e6; display: flex; flex-direction: column; }
        .panel-header { padding: 6px 12px; background: #e9ecef; border-bottom: 1px solid #dee2e6; font-weight: bold; font-size: 12px; color: #495057; display:flex; align-items:center; justify-content: space-between; }
        
        #graph-section { flex: 1; display: flex; flex-direction: column; padding: 5px; position: relative; min-height: 0; }
        #graph-controls { padding: 5px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; margin-bottom: 5px; font-size: 11px; }
        .ctrl-row { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; margin-bottom: 3px; }
        .inp { padding: 3px; border: 1px solid #ced4da; border-radius: 3px; font-size: 11px; width: 50px; text-align: center; }
        .inp-sel { padding: 2px; border: 1px solid #ced4da; border-radius: 3px; font-size: 11px; }
        #chart-wrapper { flex: 1; position: relative; min-height: 0; width: 100%; }

        #fft-section { height: 180px; display: flex; flex-direction: column; border-top: 4px solid #dee2e6; padding: 5px; font-size: 11px; }
        
        /* Tables & Lists */
        .res-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .res-table th { background: #f1f3f5; padding: 4px; border: 1px solid #dee2e6; text-align: center; position: sticky; top: 0; z-index: 2; }
        .res-table td { padding: 4px; border: 1px solid #dee2e6; text-align: center; }
        .peak-table { width: 100%; font-size: 10px; border-collapse: collapse; }
        .peak-table th { background:#e9ecef; position:sticky; top:0; padding:4px; }
        .peak-table td { border-bottom:1px solid #eee; padding:3px; text-align: center; }

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; height: 60%; background: #fff; border: 1px solid #adb5bd; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; flex-direction: column; }
        .modal-header { padding: 10px; background: #343a40; color: white; display: flex; justify-content: space-between; align-items: center;}
        .modal-body { flex: 1; padding: 15px; overflow-y: auto; font-size: 12px; }
        
        /* Guestbook Specific */
        #guest-list { list-style: none; padding: 0; margin: 0; }
        .guest-item { border-bottom: 1px solid #eee; padding: 8px 0; }
        .guest-nick { font-weight: bold; color: #228be6; font-size: 12px; }
        .guest-msg { color: #333; font-size: 12px; margin-top: 2px; }
        .guest-time { color: #aaa; font-size: 10px; float: right; }
        #guest-form { display: flex; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        
        /* Mobile Responsive */
        @media screen and (max-width: 768px) {
            #app { flex-direction: column; }
            #left-pane { flex: none; height: 55%; border-right: none; border-bottom: 4px solid #dee2e6; }
            #right-pane { flex: none; height: 45%; }
            #result-panel { display: none; } 
            #graph-section { height: 100%; } 
            #fft-section { display: none; } 
            #toolbar { width: 45px; }
            .tool-btn { width: 35px; height: 32px; font-size: 9px; }
            #chart-wrapper { min-height: 150px; }
        }
        
        #progress-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; flex-direction:column; z-index:20; }
    </style>
</head>
<body>

<div id="main-header">
    <div id="app-title">Online Circuit Simulator</div>
    <div class="header-btns">
        <button id="guest-btn" class="header-btn" onclick="toggleGuestbook()">üñäÔ∏è Guestbook</button>
        <button id="manual-btn" class="header-btn" onclick="toggleGuide()">üìñ Manual</button>
        <button id="lang-btn" class="header-btn" onclick="toggleLanguage()">üåê EN/KR</button>
    </div>
</div>

<div id="guide-modal" class="modal">
    <div class="modal-header">
        <span style="font-weight:bold;" data-txt="guideTitle">üìò Guide</span>
        <button style="background:none; border:none; color:white; font-weight:bold; cursor:pointer;" onclick="toggleGuide()">‚úï</button>
    </div>
    <div class="modal-body"><ul id="guide-list"></ul></div>
</div>

<div id="guest-modal" class="modal">
    <div class="modal-header">
        <span style="font-weight:bold;" data-txt="guestTitle">üñäÔ∏è Guestbook</span>
        <button style="background:none; border:none; color:white; font-weight:bold; cursor:pointer;" onclick="toggleGuestbook()">‚úï</button>
    </div>
    <div class="modal-body">
        <div id="guest-form">
            <input type="text" id="g-nick" class="inp" placeholder="Nick" style="width:70px; text-align:left;">
            <input type="text" id="g-msg" class="inp" placeholder="Message" style="flex:1; text-align:left;">
            <button class="header-btn" onclick="addGuestEntry()" data-txt="btn_write">Write</button>
        </div>
        <ul id="guest-list">
            <li style="text-align:center; color:#999; padding:20px;">Loading...</li>
        </ul>
    </div>
</div>

<div id="app">
    <div id="left-pane" class="pane">
        <div id="container"></div>
        
        <div id="canvas-controls">
            <div class="ctrl-group">
                <span>GRID</span>
                <button class="float-btn" onclick="updateRailCount(-1)">-</button>
                <button class="float-btn" onclick="updateRailCount(1)">+</button>
            </div>
            <div class="ctrl-group">
                <span>ZOOM</span>
                <button class="float-btn" onclick="updateZoom(0.9)">-</button>
                <button class="float-btn" onclick="updateZoom(1.1)">+</button>
            </div>
        </div>

        <div id="toolbar">
            <div style="font-size:9px; text-align:center; color:#888; font-weight:bold;">FILE</div>
            <button class="tool-btn" onclick="saveCircuit()">üíæ</button>
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()">üìÇ</button>
            <input type="file" id="fileInput" style="display:none" onchange="loadCircuit(this)">
            
            <div style="font-size:9px; text-align:center; color:#888; font-weight:bold; margin-top:5px;">ADD</div>
            <button class="tool-btn" onclick="spawn('V_DC')"><b style="color:#e03131">V</b>DC</button>
            <button class="tool-btn" onclick="spawn('V_AC')"><b style="color:#1971c2">~</b>AC</button>
            <button class="tool-btn" onclick="spawn('R')"><b>R</b></button>
            <button class="tool-btn" onclick="spawn('L')"><b>L</b></button>
            <button class="tool-btn" onclick="spawn('C')"><b>C</b></button>
            <button class="tool-btn" onclick="spawn('T')"><b style="color:#f08c00">T</b></button>
            
            <div style="font-size:9px; text-align:center; color:#888; font-weight:bold; margin-top:5px;">ACT</div>
            <button class="tool-btn" style="background:#e7f5ff; border-color:#339af0;" onclick="runSteady()">‚ö°</button>
            <button class="tool-btn" style="background:#ffe3e3; border-color:#fa5252;" onclick="resetAll()">üóëÔ∏è</button>
        </div>

        <div id="result-panel">
            <div class="panel-header"><span data-txt="resTitle">üìä Steady State Analysis</span></div>
            <div id="custom-calc-area">
                <input type="text" id="formula-inp" placeholder="e.g. V(N1)*conj(I(R1))">
                <button class="header-btn" style="padding:2px 6px;" onclick="addCustomFormula()">Add</button>
            </div>
            <div id="res-content" style="flex:1; overflow-y:auto; padding:0;"><div style="color:#888;font-size:11px;text-align:center;padding-top:20px;" data-txt="resPlaceholder">Result Table</div></div>
        </div>
    </div>

    <div id="right-pane" class="pane">
        <div id="graph-section">
            <div id="graph-controls">
                <div class="ctrl-row" style="justify-content: space-between;">
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span class="ctrl-label" data-txt="l_time">Time</span>
                        <input type="number" id="xMax" class="inp" value="50">
                        <select id="timeUnit" class="inp-sel"><option value="us">us</option><option value="ms" selected>ms</option><option value="s">s</option></select>
                        <span class="ctrl-label" style="margin-left:5px;">dt</span>
                        <input type="text" id="dtInput" class="inp" value="10u">
                    </div>
                    <div>
                        <button class="header-btn" style="background:#fab005; border:none; color:white;" onclick="autoSetParams()">Auto</button>
                    </div>
                </div>
                <div class="ctrl-row">
                    <button class="header-btn" style="flex:1; background:#228be6; border:none;" onclick="startSimulation()"><span data-txt="b_run">‚ñ∂ Run</span></button>
                    <button class="header-btn" style="flex:1; background:#fa5252; border:none;" onclick="stopSimulation()"><span data-txt="b_stop">‚èπ Stop</span></button>
                </div>
            </div>
            <div id="chart-wrapper">
                <canvas id="myChart"></canvas>
                <div id="progress-overlay">
                    <div style="font-weight:bold; color:#555;">Running...</div>
                    <div id="p-bar"><div id="p-fill"></div></div>
                    <div id="status-text">0%</div>
                </div>
            </div>
        </div>
        <div id="fft-section">
            <div class="panel-header"><span>üìä FFT</span> <button class="header-btn" style="padding:1px 5px;" onclick="performFFT()">Update</button></div>
            <div style="display:flex; gap:5px; padding:2px;">
                <select id="fft-src" class="inp-sel" style="flex:1;"></select>
            </div>
            <div id="fft-chart-area"><canvas id="fftChart"></canvas></div>
        </div>
    </div>
</div>

<script>
    // --- SUPABASE CONFIGURATION (Fixed Variable Name) ---
    // [!] Î≥∏Ïù∏Ïùò Ï†ïÌôïÌïú Supabase URLÍ≥º Anon KeyÎ•º ÏïÑÎûòÏóê ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
    const SUPABASE_URL = 'https://rhiaahzaftsfnbaywcby.supabase.co'; // Ïòà: https://xyz.supabase.co
    const SUPABASE_KEY = 'sb_publishable_iDFJ6pJRKCbwaE1SQleLMg_mOHD8Q4z'; // Ïòà: eyJ... (Anon Key)
    
    // [ÏàòÏ†ï Ìè¨Ïù∏Ìä∏] Î≥ÄÏàòÎ™ÖÏùÑ supabase -> supabaseClientÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ Ï∂©Îèå Î∞©ÏßÄ
    const supabaseClient = (SUPABASE_URL && SUPABASE_KEY.startsWith('ey')) 
                           ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) 
                           : null;

    // --- GUESTBOOK LOGIC ---
    function toggleGuestbook() {
        const m = document.getElementById('guest-modal');
        const isOpening = m.style.display !== 'flex';
        m.style.display = isOpening ? 'flex' : 'none';
        if(isOpening) loadGuestbook();
    }

    async function loadGuestbook() {
        if(!supabaseClient) {
            document.getElementById('guest-list').innerHTML = '<li style="text-align:center; padding:10px;">Supabase Key Missing or Invalid.</li>';
            return;
        }
        const { data, error } = await supabaseClient.from('circuitsim').select('*').order('created_at', { ascending: false }).limit(50);
        if(error) {
            console.error(error);
            document.getElementById('guest-list').innerHTML = '<li style="color:red">Error loading data. Check Console.</li>';
            return;
        }
        renderGuestList(data);
    }

    function renderGuestList(data) {
        const ul = document.getElementById('guest-list');
        ul.innerHTML = "";
        if(!data || data.length === 0) {
            ul.innerHTML = '<li style="text-align:center; padding:10px; color:#999;">No messages yet.</li>';
            return;
        }
        data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'guest-item';
            const date = new Date(item.created_at).toLocaleDateString();
            li.innerHTML = `<span class="guest-time">${date}</span><div class="guest-nick">${escapeHtml(item.nickname)}</div><div class="guest-msg">${escapeHtml(item.message)}</div>`;
            ul.appendChild(li);
        });
    }

    async function addGuestEntry() {
        if(!supabaseClient) return alert("Supabase Not Configured");
        const nick = document.getElementById('g-nick').value.trim();
        const msg = document.getElementById('g-msg').value.trim();
        if(!nick || !msg) return alert("Please fill nickname and message.");

        const { error } = await supabaseClient.from('circuitsim').insert([{ nickname: nick, message: msg }]);
        if(error) {
            alert("Error writing: " + error.message);
        } else {
            document.getElementById('g-msg').value = '';
            loadGuestbook(); // Reload list
        }
    }

    function escapeHtml(text) {
        if(!text) return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // --- TEXTS ---
    let curLang = 'ko';
    const texts = {
        ko: { 
            guestTitle: "üñäÔ∏è Î∞©Î™ÖÎ°ù", btn_write: "ÎÇ®Í∏∞Í∏∞", guideTitle: "üìò Ïï± ÏÇ¨Ïö© Í∞ÄÏù¥Îìú",
            resTitle: "üìä Ï†ïÏÉÅÏÉÅÌÉú Ìï¥ÏÑù Í≤∞Í≥º", resPlaceholder: "[‚ö° Ï†ïÏÉÅÏÉÅÌÉú] Î≤ÑÌäºÏùÑ ÎàåÎü¨ Í≤∞Í≥ºÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.",
            transTitle: "üìà Í≥ºÎèÑÏùëÎãµ ÏãúÎÆ¨Î†àÏù¥ÏÖò", l_time: "ÏãúÍ∞Ñ", b_run: "‚ñ∂ Ïã§Ìñâ", b_stop: "‚èπ Ï†ïÏßÄ",
            guideItems: ["<b>ÏÜåÏûê Ï∂îÍ∞Ä:</b> Ìà¥Î∞î Î≤ÑÌäº ÌÅ¥Î¶≠.", "<b>Ïù¥Îèô/Ïó∞Í≤∞:</b> ÎìúÎûòÍ∑∏.", "<b>Í∞í Î≥ÄÍ≤Ω:</b> ÎçîÎ∏îÌÅ¥Î¶≠ (Î™®Î∞îÏùºÏùÄ ÎçîÎ∏îÌÉ≠).", "<b>GND ÏÑ§Ï†ï:</b> ÏÑ∏Î°ú Ï†êÏÑ† ÏÉÅÎã® Ïà´Ïûê Î∞ïÏä§ ÌÅ¥Î¶≠.", "<b>ÌôïÎåÄ/Ï∂ïÏÜå:</b> Ïö∞Ï∏° ÌïòÎã® +/- Î≤ÑÌäº.", "<b>Í∑∏ÎûòÌîÑ:</b> [Run] Î≤ÑÌäºÏúºÎ°ú Í≥ºÎèÑÏùëÎãµ ÌôïÏù∏."],
            th_var: "Î≥ÄÏàò/ÏàòÏãù", th_mag: "Peak (Mag)", th_rms: "RMS", th_ph: "ÏúÑÏÉÅ (deg)"
        },
        en: { 
            guestTitle: "üñäÔ∏è Guestbook", btn_write: "Write", guideTitle: "üìò App User Guide",
            resTitle: "üìä Steady State Result", resPlaceholder: "Press [‚ö° Steady State] to see results.",
            transTitle: "üìà Transient Simulation", l_time: "Time", b_run: "‚ñ∂ Run", b_stop: "‚èπ Stop",
            guideItems: ["<b>Spawn:</b> Click toolbar.", "<b>Move/Connect:</b> Drag.", "<b>Edit:</b> Double click/tap.", "<b>GND:</b> Click rail number box.", "<b>Zoom:</b> Use +/- buttons.", "<b>Graph:</b> Press [Run]."],
            th_var: "Variable/Formula", th_mag: "Peak (Mag)", th_rms: "RMS", th_ph: "Phase (deg)"
        }
    };
    function toggleLanguage(){ curLang = (curLang==='ko') ? 'en' : 'ko'; updateText(); }
    function updateText(){ 
        const t = texts[curLang];
        document.querySelectorAll('[data-txt]').forEach(el => { const key = el.getAttribute('data-txt'); if(t[key]) el.innerHTML = t[key]; });
        document.getElementById('guide-list').innerHTML = t.guideItems.map(i=>`<li>${i}</li>`).join(''); 
        document.getElementById('g-nick').placeholder = curLang==='ko'?'ÎãâÎÑ§ÏûÑ':'Nick';
        document.getElementById('g-msg').placeholder = curLang==='ko'?'Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî':'Message';
        if(steadyResults) renderSteadyResults(); 
    }
    function toggleGuide() { const m = document.getElementById('guide-modal'); m.style.display = m.style.display==='flex'?'none':'flex'; }

    // --- SETUP & KONVA ---
    const stage = new Konva.Stage({ container: 'container', width: window.innerWidth, height: window.innerHeight, draggable: true });
    const layer = new Konva.Layer(); stage.add(layer);
    let stageScale = 1;
    function updateZoom(factor) { stageScale *= factor; stage.scale({ x: stageScale, y: stageScale }); stage.batchDraw(); }
    window.addEventListener('resize', () => { const cnt = document.getElementById('container'); stage.width(cnt.offsetWidth); stage.height(cnt.offsetHeight); drawGrid(); });

    let railCount=6; const START_X=100, BASE_W=100;
    let groundRails = new Set([1]);
    let components=[], idCnt={R:0,L:0,C:0,V:0,T:0,I:0};

    function drawGrid(){
        layer.find('.g').forEach(n=>n.destroy());
        layer.add(new Konva.Line({ points:[START_X-50, 400, START_X+railCount*BASE_W+50, 400], stroke:'#212529', strokeWidth:3, name:'g' }));
        layer.add(new Konva.Text({ x:START_X-80, y:410, text:'0(GND)', fontStyle:'bold', fill:'#212529', name:'g' }));
        for(let i=1; i<=railCount; i++){
            const x = START_X + (i-1)*BASE_W;
            const isG = groundRails.has(i);
            const l = new Konva.Line({ points:[x, 50, x, 400], stroke: isG ? '#212529':'#adb5bd', strokeWidth: isG?3:1, dash: isG?[]:[4,4], name:'g' });
            const grp = new Konva.Group({ x:x, y:30, name:'g' });
            grp.add(new Konva.Rect({ x:-15, y:-12, width:30, height:24, fill:isG?'#343a40':'#fff', stroke:'#ced4da', cornerRadius:10 }));
            grp.add(new Konva.Text({ x:-15, y:-6, width:30, align:'center', text: isG ? `G${i}` : `${i}`, fill: isG?'#fff':'#495057', fontSize:11, fontStyle:'bold' }));
            grp.on('click tap', () => { if(groundRails.has(i)) groundRails.delete(i); else groundRails.add(i); drawGrid(); });
            grp.on('mouseenter',()=>document.body.style.cursor='pointer'); grp.on('mouseleave',()=>document.body.style.cursor='default');
            layer.add(l); layer.add(grp);
        }
        components.forEach(c=>updateComp(c));
        layer.batchDraw();
    }
    function updateRailCount(d){ let n=railCount+d; if(n<2)return; railCount=n; drawGrid(); }

    function spawn(type, params=null){
        let c;
        if(params) { c = { ...params }; c.group=null; c.lineL=null; c.lineR=null; c.labelObj=null; }
        else {
            let cat = type.includes('V')?'V':(type.includes('I')?'I':type.charAt(0));
            idCnt[cat]++; const name = cat+idCnt[cat];
            c = { name, type, val:0, freq:60, phase:0, unit:'', nL:1, nR:2, ratio:1 };
            if(type==='R'){ c.val=1000; c.unit='Œ©'; } else if(type==='L'){ c.val=10e-3; c.unit='H'; } else if(type==='C'){ c.val=100e-6; c.unit='F'; }
            else if(type==='V_DC'){ c.val=10; c.unit='V'; } else if(type==='V_AC'){ c.val=220; c.unit='V'; }
        }
        const initX = c.uiX!==undefined ? c.uiX : (START_X + BASE_W/2);
        const initY = c.uiY!==undefined ? c.uiY : 100;
        const g = new Konva.Group({ x:initX, y:initY, draggable:true });
        const wL = new Konva.Line({ points:[], stroke:'#000', strokeWidth:2, dash:[2,2], name:'w' });
        const wR = new Konva.Line({ points:[], stroke:'#000', strokeWidth:2, dash:[2,2], name:'w' });
        layer.add(wL); layer.add(wR); c.lineL=wL; c.lineR=wR;
        const shape = drawShape(c.type); g.add(shape);
        const lbl = new Konva.Text({ x:-50, y:-45, width:100, align:'center', fontSize:11, fontStyle:'bold', fill:'#333', text:getLabel(c) });
        g.add(lbl); c.labelObj=lbl; c.group=g;
        g.on('dragmove', ()=>updateComp(c, true));
        g.on('dragend', ()=>{
            c.uiX = g.x(); c.uiY = g.y();
            const gx = g.x();
            const isVertical = (c.nL===0 || c.nR===0);
            if(isVertical) {
                let idx = Math.round((gx - START_X)/BASE_W) + 1;
                if(idx<1) idx=1; if(idx>railCount) idx=railCount;
                if(c.nL===0) c.nR=idx; else c.nL=idx;
            } else {
                let lIdx = Math.round((gx - START_X - BASE_W/2)/BASE_W);
                let nL = lIdx+1; if(nL<1) nL=1; if(nL>=railCount) nL=railCount-1;
                c.nL = nL; c.nR = nL+1;
            }
            updateComp(c);
        });
        g.on('dblclick dbltap', ()=>{
            let def=`${c.nL},${c.nR}`; 
            let msg=`[${c.name}] Nodes(N1,N2)`;
            if(c.type==='T'){ msg+=', Ratio'; def+=`,${c.ratio}`; } else { msg+=', Val'; def+=`,${c.val}`; }
            if(c.type.includes('AC')){ msg+=', Freq, Phase'; def+=`,${c.freq},${c.phase}`; }
            const ret = prompt(msg, def);
            if(ret) {
                const p = ret.split(',');
                const nL=parseInt(p[0]), nR=parseInt(p[1]);
                if(nL===0 && nR===1) return alert('Inv');
                c.nL=nL; c.nR=nR;
                if(c.type==='T'){ if(p[2]) c.ratio=parseFloat(p[2]); }
                else { 
                    if(p[2]) c.val=parseFloat(p[2]); 
                    if(c.type.includes('AC')){ if(p[3]) c.freq=parseFloat(p[3]); if(p[4]) c.phase=parseFloat(p[4]); }
                }
                lbl.text(getLabel(c)); updateComp(c); layer.batchDraw();
            }
        });
        g.on('contextmenu', (e)=>{ e.evt.preventDefault(); if(confirm('Delete?')){ g.destroy(); wL.destroy(); wR.destroy(); components=components.filter(x=>x!==c); layer.batchDraw(); } });
        components.push(c); layer.add(g); updateComp(c); layer.batchDraw();
    }

    function updateComp(c, dragging=false){
        const isVertical = (c.nL===0 || c.nR===0);
        if(dragging) return;
        if(isVertical){
            const tNode = (c.nL===0)?c.nR:c.nL;
            const tx = START_X + (tNode-1)*BASE_W;
            let ty = c.group.y(); if(ty<60) ty=60; if(ty>380) ty=380;
            c.group.rotation(90); c.group.position({x:tx, y:ty});
            c.lineL.points([tx, 50, tx, ty-50]); c.lineR.points([tx, ty+50, tx, 400]);
            c.labelObj.rotation(-90); c.labelObj.position({x:15, y:-10});
        } else {
            const xL = START_X + (c.nL-1)*BASE_W;
            const xR = START_X + (c.nR-1)*BASE_W;
            const cx = (xL+xR)/2;
            let cy = c.group.y(); if(cy<60) cy=60; if(cy>380) cy=380;
            c.group.rotation(0); c.group.position({x:cx, y:cy});
            c.lineL.points([xL, cy, cx-50, cy]); c.lineR.points([cx+50, cy, xR, cy]);
            c.labelObj.rotation(0); c.labelObj.position({x:-50, y:-45});
        }
        const col = c.type==='T'?'#f08c00':'#333';
        c.lineL.stroke(col); c.lineR.stroke(col);
    }

    function getLabel(c){
        if(c.type==='T') return `${c.name}\n1:${c.ratio}`;
        let t=`${c.name}\n${formatUnit(c.val,c.unit)}`;
        if(c.type.includes('AC')) t+=`\n${c.freq}Hz ${c.phase}¬∞`;
        return t;
    }

    function drawShape(type) {
        const g = new Konva.Group({offsetX:50, offsetY:20});
        g.add(new Konva.Rect({width:100, height:40, fill:'transparent'}));
        const l=(p,w=2,col='#333')=>new Konva.Line({points:p,stroke:col,strokeWidth:w,lineCap:'round',lineJoin:'round'});
        const mid=20;
        if(type==='R') g.add(l([0,mid, 20,mid, 25,mid-10, 35,mid+10, 45,mid-10, 55,mid+10, 65,mid-10, 75,mid+10, 80,mid, 100,mid]));
        else if(type==='L'){ g.add(new Konva.Path({x:20, y:mid, data:'M0,0 q7,-15 14,0 q7,-15 14,0 q7,-15 14,0 q7,-15 14,0', stroke:'#333', strokeWidth:2})); g.add(l([0,mid, 20,mid])); g.add(l([76,mid, 100,mid])); }
        else if(type==='C'){ g.add(l([0,mid, 45,mid])); g.add(l([55,mid, 100,mid])); g.add(l([45,mid-12, 45,mid+12])); g.add(l([55,mid-12, 55,mid+12])); }
        else if(type.includes('V')){
            g.add(l([0,mid, 40,mid])); g.add(l([60,mid, 100,mid]));
            if(type==='V_DC'){ g.add(l([40,mid-8, 40,mid+8], 3)); g.add(l([60,mid-16, 60,mid+16], 3)); g.add(new Konva.Text({x:65, y:mid-15, text:'+', fontSize:14, fill:'red', fontStyle:'bold'})); }
            else { g.add(new Konva.Circle({x:50, y:mid, radius:15, stroke:'#333', strokeWidth:2, fill:'white'})); g.add(new Konva.Path({x:43, y:mid, data:'M0,0 q3.5,-6 7,0 t7,0', stroke:'#333', strokeWidth:2})); }
        }
        else if(type==='T'){
            g.add(l([48,5, 48,35], 2)); g.add(l([52,5, 52,35], 2));
            g.add(l([0,20, 25,20, 25,10, 35,10], 2)); g.add(new Konva.Path({data:"M35,10 c-6,0 -6,6 0,6 c-6,0 -6,6 0,6 c-6,0 -6,6 0,6", stroke:'#333', strokeWidth:2}));
            g.add(l([35,28, 35,32], 2)); g.add(l([28,32, 42,32], 2)); g.add(l([31,35, 39,35], 2)); g.add(l([34,38, 36,38], 2));
            g.add(l([100,20, 75,20, 75,10, 65,10], 2)); g.add(new Konva.Path({data:"M65,10 c6,0 6,6 0,6 c6,0 6,6 0,6 c6,0 6,6 0,6", stroke:'#333', strokeWidth:2}));
            g.add(l([65,28, 65,32], 2)); g.add(l([58,32, 72,32], 2)); g.add(l([61,35, 69,35], 2)); g.add(l([64,38, 66,38], 2));
        }
        return g;
    }

    // --- UTILS & MATH (Same as previous) ---
    function formatUnit(v,u){ if(Math.abs(v)<1e-15) return "0"+u; if(Math.abs(v)>=1e6) return (v/1e6).toFixed(2)+"M"+u; if(Math.abs(v)>=1e3) return (v/1e3).toFixed(2)+"k"+u; if(Math.abs(v)>=1) return v.toFixed(2)+u; if(Math.abs(v)>=1e-3) return (v*1e3).toFixed(2)+"m"+u; if(Math.abs(v)>=1e-6) return (v*1e6).toFixed(2)+"u"+u; return v.toExponential(1)+u; }
    function parseUnit(s){ if(!s) return NaN; s=s.toString(); const m=s.match(/^([\d\.]+)([a-zA-Z]*)$/); if(!m) return parseFloat(s); const v=parseFloat(m[1]), u=m[2]; if(u==='k') return v*1e3; if(u==='u') return v*1e-6; if(u==='m') return v*1e-3; if(u==='M') return v*1e6; return v; }
    function refreshIdCounters(){ idCnt = {R:0,L:0,C:0,V:0,T:0,I:0}; components.forEach(c => { const m = c.name.match(/^([a-zA-Z]+)(\d+)$/); if(m){ let cat = m[1]; if(c.type.includes('V')) cat='V'; else if(c.type.includes('I')) cat='I'; else cat=c.type.charAt(0); if(idCnt[cat]!==undefined && idCnt[cat] < parseInt(m[2])) idCnt[cat] = parseInt(m[2]); } }); }

    // --- FILE I/O ---
    function saveCircuit(){ if(components.length===0) return alert("Empty"); const d = { railCount, groundRails:Array.from(groundRails), components: components.map(c=>({ ...c, group:undefined, lineL:undefined, lineR:undefined, labelObj:undefined })) }; const b = new Blob([JSON.stringify(d)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='circuit.json'; a.click(); }
    function loadCircuit(input){ const f=input.files[0]; if(!f) return; const r=new FileReader(); r.onload = (e) => { try { const d = JSON.parse(e.target.result); resetAll(); railCount = d.railCount||6; groundRails = new Set(d.groundRails||[1]); d.components.forEach(c => spawn(c.type, c)); refreshIdCounters(); drawGrid(); } catch(err){ alert("Error"); } }; r.readAsText(f); input.value=''; }
    function resetAll(){ components.forEach(c=>{ c.group.destroy(); c.lineL.destroy(); c.lineR.destroy(); }); components=[]; idCnt={R:0,L:0,C:0,V:0,T:0,I:0}; if(myChart) myChart.destroy(); document.getElementById('res-content').innerHTML = ''; drawGrid(); }

    // --- SIMULATION LOGIC (Copied from v45) ---
    function runSteady() {
        const s=getSetup(); if(!s)return; const {map,N}=s;
        const ac=components.find(c=>c.type.includes('AC')), freq=ac?ac.freq:0, w=2*Math.PI*freq;
        const Vs=components.filter(c=>c.type.includes('V')), Ts=components.filter(c=>c.type==='T');
        const size=N+Vs.length+Ts.length;
        let A=math.zeros(size,size,'dense'), B=math.zeros(size,1,'dense');
        const vOff=N, tOff=vOff+Vs.length;
        components.forEach(c=>{
            const n1=map[c.nL], n2=map[c.nR];
            if(['R','L','C'].includes(c.type)) {
                let Y = math.complex(0,0);
                if(c.type==='R') Y=math.complex(1/c.val,0);
                else if(c.type==='L') Y=(w===0)?math.complex(1e9,0):math.complex(0, -1/(w*c.val));
                else if(c.type==='C') Y=(w===0)?math.complex(0,0):math.complex(0, w*c.val);
                if(n1>=0) A.set([n1,n1],math.add(A.get([n1,n1]),Y));
                if(n2>=0) A.set([n2,n2],math.add(A.get([n2,n2]),Y));
                if(n1>=0&&n2>=0){ const nY=math.multiply(Y,-1); A.set([n1,n2],math.add(A.get([n1,n2]),nY)); A.set([n2,n1],math.add(A.get([n2,n1]),nY)); }
            }
            else if(c.type.includes('V')) {
                const idx=vOff+Vs.indexOf(c);
                if(n2>=0){A.set([n2,idx],1);A.set([idx,n2],1);} if(n1>=0){A.set([n1,idx],-1);A.set([idx,n1],-1);}
                const phi = (c.phase || 0) * Math.PI / 180;
                B.set([idx,0], math.complex(c.val * Math.cos(phi), c.val * Math.sin(phi)));
            }
            else if(c.type === 'I_AC') {
                const phi = (c.phase || 0) * Math.PI / 180;
                const I = math.complex(c.val * Math.cos(phi), c.val * Math.sin(phi));
                if(n1>=0) B.set([n1,0], math.add(B.get([n1,0]), I));
                if(n2>=0) B.set([n2,0], math.subtract(B.get([n2,0]), I));
            }
            else if(c.type==='T') {
                const idx=tOff+Ts.indexOf(c);
                if(n2>=0){A.set([n2,idx],1);A.set([idx,n2],1);} if(n1>=0){A.set([n1,idx],-c.ratio);A.set([idx,n1],-c.ratio);}
            }
        });
        try {
            const X=math.lusolve(A,B);
            steadyResults = { nodes: {}, currents: {} };
            const invMap = {}; Object.keys(map).forEach(k=>{if(map[k]>=0)invMap[map[k]]=k;});
            for(let i=0;i<N;i++) steadyResults.nodes[`N${invMap[i]}`] = X.get([i,0]);
            steadyResults.nodes[`N0`] = math.complex(0,0);
            components.forEach(c => {
                let I = math.complex(0,0);
                const n1=map[c.nL], n2=map[c.nR];
                const v1 = n1>=0 ? X.get([n1,0]) : math.complex(0,0);
                const v2 = n2>=0 ? X.get([n2,0]) : math.complex(0,0);
                const V_drop = math.subtract(v1, v2);
                if(c.type === 'R') I = math.divide(V_drop, c.val); 
                else if(c.type === 'L') I = (w===0)?math.complex(1e9,0):math.divide(V_drop, math.complex(0, w*c.val));
                else if(c.type === 'C') I = math.divide(V_drop, math.complex(0, -1/(w*c.val)));
                else if(c.type.includes('V')) I = X.get([vOff + Vs.indexOf(c), 0]);
                else if(c.type === 'I_AC') { const phi = (c.phase||0)*Math.PI/180; I = math.complex(c.val*Math.cos(phi), c.val*Math.sin(phi)); }
                else if(c.type === 'T') I = X.get([tOff + Ts.indexOf(c), 0]);
                steadyResults.currents[c.name] = I;
            });
            renderSteadyResults();
        } catch(e){ console.error(e); document.getElementById('res-content').innerHTML='Matrix Error (Singular?)'; }
    }

    function renderSteadyResults() {
        if(!steadyResults) return;
        const t=texts[curLang];
        let h=`<table class="res-table"><tr><th>${t.th_var}</th><th>${t.th_mag}</th><th>${t.th_rms}</th><th>${t.th_ph}</th><th></th></tr>`;
        const row = (lbl, val) => {
            let cmplx = (val && val.re!==undefined) ? val : math.complex(val||0);
            let p = cmplx.toPolar();
            let rms = p.r / Math.SQRT2;
            return `<tr><td>${lbl}</td><td>${formatUnit(p.r,'')}</td><td>${formatUnit(rms,'')}</td><td>${(p.phi*180/Math.PI).toFixed(1)}¬∞</td><td></td></tr>`;
        };
        Object.keys(steadyResults.nodes).sort().forEach(k => { if(k!=='N0') h += row(`V(${k})`, steadyResults.nodes[k]); });
        Object.keys(steadyResults.currents).forEach(k => { h += row(`I(${k})`, steadyResults.currents[k]); });
        
        if(customFormulas.length > 0) {
            const scope = { ...steadyResults.nodes, ...steadyResults.currents, real: math.re, imaginary: math.im, absolute: math.abs,
                V: function(n) { return steadyResults.nodes[n] || math.complex(0,0); },
                I: function(c) { return steadyResults.currents[c] || math.complex(0,0); }
            };
            Object.keys(steadyResults.nodes).forEach(k => scope[k] = k);
            Object.keys(steadyResults.currents).forEach(k => scope[k] = k);
            customFormulas.forEach((fmt, idx) => {
                try {
                    const res = math.evaluate(fmt, scope);
                    h += `<tr class="custom-row"><td>${fmt}</td>`;
                    let cmplx = (typeof res === 'object' && res.re!==undefined) ? res : math.complex(res);
                    let p = cmplx.toPolar();
                    let rms = p.r / Math.SQRT2;
                    h += `<td>${formatUnit(p.r,'')}</td><td>${formatUnit(rms,'')}</td><td>${(p.phi*180/Math.PI).toFixed(3)}¬∞</td>`;
                    h += `<td><button class="btn-del-row" onclick="removeCustomFormula(${idx})">√ó</button></td></tr>`;
                } catch(e) { h += `<tr class="custom-row"><td>${fmt}</td><td colspan="3" style="color:red">Error</td><td><button class="btn-del-row" onclick="removeCustomFormula(${idx})">√ó</button></td></tr>`; }
            });
        }
        document.getElementById('res-content').innerHTML=h+`</table>`;
    }
    
    function addCustomFormula() { const inp=document.getElementById('formula-inp'); if(inp.value.trim()){ customFormulas.push(inp.value.trim()); inp.value=''; renderSteadyResults(); } }
    function removeCustomFormula(idx) { customFormulas.splice(idx, 1); renderSteadyResults(); }

    let abortSim=false;
    function stopSimulation(){abortSim=true;document.getElementById('progress-overlay').style.display='none';}
    function autoSetParams(){
        let f=60; const ac=components.filter(c=>c.type.includes('AC')); if(ac.length>0)f=Math.max(...ac.map(c=>c.freq));
        const T=1/f; let tMax=3*T, dt=T/200; if(tMax/dt>5000)dt=tMax/5000;
        let u='s'; if(tMax<1e-6)u='us'; else if(tMax<1e-3)u='ms';
        const sc=(u==='us')?1e6:(u==='ms')?1e3:1;
        document.getElementById('timeUnit').value=u; document.getElementById('xMax').value=(tMax*sc).toFixed(1);
        document.getElementById('xMin').value=0; document.getElementById('dtInput').value=formatEng(dt);
        alert(`Auto: ${formatUnit(f,'Hz')}, dt=${formatEng(dt)}`);
    }

    async function startSimulation() {
        const s=getSetup(); if(!s)return; const {map,N}=s;
        const dt=parseUnit(document.getElementById('dtInput').value);
        if(isNaN(dt)||dt<=0)return alert("Invalid dt");
        const u=document.getElementById('timeUnit').value, sc=(u==='ps')?1e-12:(u==='us')?1e-6:(u==='ms')?1e-3:1;
        const tMin=parseFloat(document.getElementById('xMin').value)*sc, tMax=parseFloat(document.getElementById('xMax').value)*sc;
        const steps=Math.floor(tMax/dt);
        if(steps>100000 && !confirm(`Points: ${steps}. Continue?`)) return;

        abortSim=false;
        const pOv=document.getElementById('progress-overlay'), pFill=document.getElementById('p-fill'), pTxt=document.getElementById('status-text');
        pOv.style.display='flex'; pFill.style.width='0%'; pTxt.innerText='Init...';

        const Ls=components.filter(c=>c.type==='L'), Vs=components.filter(c=>c.type.includes('V'));
        const Is=components.filter(c=>c.type==='I_AC');
        const Cs=components.filter(c=>c.type==='C'), Ts=components.filter(c=>c.type==='T');
        const size=N+Ls.length+Vs.length+Ts.length;
        let x=math.zeros(size,1);
        const c_prev_V=[], c_prev_I=[], l_prev_V=[], l_prev_I=[];
        Cs.forEach(()=>{c_prev_V.push(0);c_prev_I.push(0)}); Ls.forEach(()=>{l_prev_V.push(0);l_prev_I.push(0)});

        let A=math.zeros(size,size);
        const lOff=N, vOff=N+Ls.length, tOff=vOff+Vs.length;
        const addA=(r,c,v)=>{if(r>=0&&c>=0)A.set([r,c],A.get([r,c])+v)};

        components.forEach(c=>{
            const n1=map[c.nL], n2=map[c.nR];
            if(c.type==='R'){ const g=1/c.val; addA(n1,n1,g); addA(n2,n2,g); addA(n1,n2,-g); addA(n2,n1,-g); }
            else if(c.type==='C'){ const g=(2*c.val)/dt; addA(n1,n1,g); addA(n2,n2,g); addA(n1,n2,-g); addA(n2,n1,-g); }
            else if(c.type==='L'){ const idx=lOff+Ls.indexOf(c), r=(2*c.val)/dt; if(n1>=0){A.set([n1,idx],1);A.set([idx,n1],1);} if(n2>=0){A.set([n2,idx],-1);A.set([idx,n2],-1);} A.set([idx,idx],-r); }
            else if(c.type.includes('V')){ const idx=vOff+Vs.indexOf(c); if(n2>=0){A.set([n2,idx],1);A.set([idx,n2],1);} if(n1>=0){A.set([n1,idx],-1);A.set([idx,n1],-1);} }
            else if(c.type==='T'){ const idx=tOff+Ts.indexOf(c); if(n2>=0){A.set([n2,idx],1);A.set([idx,n2],1);} if(n1>=0){A.set([n1,idx],-c.ratio);A.set([idx,n1],-c.ratio);} }
        });

        const resV=Array(N).fill(0).map(()=>[]), resI=[];
        components.forEach(c=>resI.push([]));
        const timeLog=[]; const chunk=500;

        for(let s=0; s<steps; s++){
            if(abortSim) break;
            const t=s*dt;
            if(s%chunk===0){ pFill.style.width=`${(s/steps)*100}%`; pTxt.innerText=`${Math.round(s/steps*100)}%`; await new Promise(r=>setTimeout(r,0)); }

            let B=math.zeros(size,1); const addB=(r,v)=>{if(r>=0)B.set([r,0],B.get([r,0])+v)};
            Cs.forEach((c,i)=>{const n1=map[c.nL], n2=map[c.nR]; const G=(2*c.val)/dt; const I_inj=G*c_prev_V[i]+c_prev_I[i]; addB(n1,I_inj); addB(n2,-I_inj);});
            Ls.forEach((c,i)=>{const idx=lOff+i, R=(2*c.val)/dt, v_eq = -l_prev_V[i] - R*l_prev_I[i]; B.set([idx,0], v_eq);});
            
            Vs.forEach((c,i)=>{
                const idx=vOff+i; let v=c.val; 
                if(c.type==='V_AC') v *= Math.sin(2*Math.PI*c.freq*t + (c.phase||0)*Math.PI/180); 
                else if(t<0) v=0; 
                B.set([idx,0], v);
            });
            Is.forEach((c)=>{
                let val = c.val * Math.sin(2*Math.PI*c.freq*t + (c.phase||0)*Math.PI/180);
                if(map[c.nL]>=0) B.set([map[c.nL],0], B.get([map[c.nL],0]) + val);
                if(map[c.nR]>=0) B.set([map[c.nR],0], B.get([map[c.nR],0]) - val);
            });
            
            try{
                x=math.lusolve(A,B);
                Cs.forEach((c,i)=>{const v1=map[c.nL]>=0?x.get([map[c.nL],0]):0, v2=map[c.nR]>=0?x.get([map[c.nR],0]):0, v=v1-v2; const G=(2*c.val)/dt, i_new = -c_prev_I[i] + G*(v - c_prev_V[i]); c_prev_V[i]=v; c_prev_I[i]=i_new;});
                Ls.forEach((c,i)=>{const i_new=x.get([lOff+i,0]), v1=map[c.nL]>=0?x.get([map[c.nL],0]):0, v2=map[c.nR]>=0?x.get([map[c.nR],0]):0; l_prev_I[i]=i_new; l_prev_V[i]=v1-v2;});
                
                if(t>=tMin){ 
                    timeLog.push(t); 
                    for(let i=0;i<N;i++) resV[i].push(x.get([i,0])); 
                    components.forEach((c, idx) => {
                        let iVal = 0;
                        if(c.type==='R') { const v1=map[c.nL]>=0?x.get([map[c.nL],0]):0, v2=map[c.nR]>=0?x.get([map[c.nR],0]):0; iVal = (v1-v2)/c.val; }
                        else if(c.type==='C') iVal = c_prev_I[Cs.indexOf(c)]; 
                        else if(c.type==='L') iVal = l_prev_I[Ls.indexOf(c)];
                        else if(c.type.includes('V')) iVal = x.get([vOff+Vs.indexOf(c), 0]); 
                        else if(c.type==='I_AC') iVal = c.val * Math.sin(2*Math.PI*c.freq*t + (c.phase||0)*Math.PI/180);
                        else if(c.type==='T') iVal = x.get([tOff+Ts.indexOf(c), 0]); 
                        resI[idx].push(iVal);
                    });
                }
            } catch(e){break;}
        }
        pOv.style.display='none';
        
        lastSimResult = { dt, resV, resI, N, map };
        drawChart(timeLog, resV, resI, N, map, sc, u);
        updateFFTSources();
        performFFT();
    }

    let myChart=null;
    function drawChart(times, vData, iData, N, map, scale, unitStr) {
        const ctx=document.getElementById('myChart').getContext('2d');
        if(myChart) myChart.destroy();
        const labels=times.map(t=>(t/scale).toFixed(3));
        const sets=[]; const cols=['#e03131','#1971c2','#2f9e44','#f08c00','#9c36b5'];
        const invMap = {}; Object.keys(map).forEach(k => { if(map[k] >= 0) invMap[map[k]] = k; });

        for(let i=0;i<N;i++){
            sets.push({ label:`V(N${invMap[i]})`, data:vData[i], borderColor:cols[i%cols.length], borderWidth:2, pointRadius:0, yAxisID: 'y' });
        }
        components.forEach((c, idx) => {
            const hidden = !(c.type.includes('V') || c.type==='L' || c.type==='I_AC');
            sets.push({ label:`I(${c.name})`, data:iData[idx], borderColor: '#868e96', borderWidth:1.5, borderDash: [5, 5], pointRadius:0, hidden: true, yAxisID: 'y' });
        });

        const yMax=document.getElementById('yMax').value;
        myChart=new Chart(ctx,{
            type:'line',data:{labels,datasets:sets},
            options:{
                responsive:true,maintainAspectRatio:false,animation:false,
                scales:{ x:{title:{display:true,text:`Time (${unitStr})`},ticks:{maxTicksLimit:8}}, y:{min:yMax?-yMax:undefined,max:yMax?yMax:undefined, title:{display:true, text:'Voltage (V) / Current (A)'}} },
                plugins: { legend: { labels: { usePointStyle: true, boxWidth: 6 } } }
            }
        });
    }

    // --- FFT (Copied from v45) ---
    let fftChart = null;
    function updateFFTSources() {
        const sel = document.getElementById('fft-src');
        sel.innerHTML = "";
        if(!lastSimResult) return;
        const { map, N } = lastSimResult;
        const invMap = {}; Object.keys(map).forEach(k => { if(map[k] >= 0) invMap[map[k]] = k; });
        for(let i=0; i<N; i++) { const opt = document.createElement('option'); opt.value = `v:${i}`; opt.text = `V(N${invMap[i]})`; sel.appendChild(opt); }
        components.forEach((c, idx) => { const opt = document.createElement('option'); opt.value = `i:${idx}`; opt.text = `I(${c.name})`; if(c.type.includes('V') || c.type === 'L') sel.appendChild(opt); });
    }
    function performFFT() {
        const placeholder = document.getElementById('fft-placeholder');
        if(!lastSimResult) { placeholder.style.display = 'block'; if(fftChart) fftChart.clear(); return; }
        placeholder.style.display = 'none';
        const { dt, resV, resI } = lastSimResult;
        const val = document.getElementById('fft-src').value;
        if(!val) return; 
        let fMin = parseFloat(document.getElementById('fft-min').value), fMax = parseFloat(document.getElementById('fft-max').value);
        if(isNaN(fMin) || fMin < 0) fMin = 0; if(isNaN(fMax) || fMax <= fMin) fMax = fMin + 1000;
        const [type, idxStr] = val.split(':');
        const idx = parseInt(idxStr);
        const data = (type === 'v') ? resV[idx] : resI[idx];
        let spectrum = SimpleFFT.calculateSpectrum(data, dt);
        spectrum = spectrum.filter(s => s.x >= fMin && s.x <= fMax);
        const sorted = [...spectrum].sort((a,b) => b.y - a.y).slice(0, 10);
        const tbody = document.getElementById('peak-tbody'); tbody.innerHTML = "";
        sorted.forEach((p, i) => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${p.x.toFixed(3)}</td><td>${p.y.toExponential(3)}</td>`; tr.onclick = () => highlightBar(p.x); tr.id = `peak-row-${p.x.toFixed(3).replace('.','_')}`; tbody.appendChild(tr); });
        const ctx = document.getElementById('fftChart').getContext('2d');
        if(fftChart) fftChart.destroy();
        const labels = spectrum.map(s => s.x.toFixed(1));
        const mags = spectrum.map(s => s.y);
        fftChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Magnitude', data: mags, backgroundColor: (ctx) => { const idx = ctx.dataIndex; const labelFreq = ctx.chart.data.labels[idx]; return selectedFreq === labelFreq ? '#e03131' : '#862e9c'; }, barPercentage: 1.0, categoryPercentage: 1.0 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Freq (Hz)' }, ticks: { maxTicksLimit: 10 } }, y: { title: { display: true, text: 'Mag' } } }, onClick: (e, els) => { if(els.length > 0) { const idx = els[0].index; const freq = labels[idx]; highlightBar(freq); } }, plugins: { tooltip: { callbacks: { label: (ctx) => `Mag: ${ctx.raw.toExponential(3)}` } }, legend: { display: false } } }
        });
    }

    // Init
    updateText();
    drawGrid();
</script>
</body>
</html>
